<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Alumnos de Educacion Fisica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilos basicos para un diseno moderno y elegante */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Fondo suave */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 960px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        input, select, button {
            border-radius: 0.25rem;
        }

        /* Estilos para la barra de navegacion */
        .navbar {
            background-color: #4a90e2; /* Azul */
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }
        .navbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 960px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .navbar-brand {
            color: #ffffff;
            font-size: 1.25rem;
            font-weight: bold;
            text-decoration: none;
        }
        .navbar-nav {
            display: flex;
            gap: 1rem;
        }
        .nav-link {
            color: #e0e0e0; /* Gris claro */
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: #ffffff;
        }


        /* Estilos de tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
         tbody tr:nth-child(even) {
             background-color: #f9f9f9;
         }

        /* Estilos de botones */
        button {
            padding: 0.5rem 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .bg-blue-500 { background-color: #3b82f6; }
        .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
        .generate-button { background-color: #2ecc71; } /* Verde */
        .generate-button:hover { background-color: #27ae60; }
        .compare-button { background-color: #f39c12; } /* Naranja */
        .compare-button:hover { background-color: #e67e22; }
        .delete-button { background-color: #e74c3c; } /* Rojo */
        .delete-button:hover { background-color: #c0392b; }
         .import-button { background-color: #9b59b6; } /* Purpura */
         .import-button:hover { background-color: #8e44ad; }
          .export-button { background-color: #1abc9c; } /* Turquesa */
          .export-button:hover { background-color: #16a085; }
           .print-button { background-color: #3498db; } /* Azul */
           .print-button:hover { background-color: #2980b9; }
           .print-list-button { background-color: #1abc9c; } /* Turquesa */
           .print-list-button:hover { background-color: #16a085; }

        /* Estilos para botones inline en tablas */
        .inline-action-btn {
             padding: 0.25rem 0.5rem; /* Padding mas pequeno */
             font-size: 0.875rem; /* Texto mas pequeno */
             margin-right: 0.25rem; /* Espacio entre botones */
        }
         .inline-action-btn i {
             margin-right: 0.25rem; /* Espacio entre icono y texto */
         }
         .save-inline-edit-btn { background-color: #28a745; color: white; } /* Verde */
         .save-inline-edit-btn:hover { background-color: #218838; }
         .cancel-inline-edit-btn { background-color: #6c757d; color: white; } /* Gris */
         .cancel-inline-edit-btn:hover { background-color: #5a6268; }
         .edit-record-btn { background-color: #ffc107; color: white; } /* Amarillo */
         .edit-record-btn:hover { background-color: #e0a800; }
         .delete-record-btn { background-color: #dc3545; color: white; } /* Rojo */
         .delete-record-btn:hover { background-color: #c82333; }


        /* Estilos de busqueda y resultados */
          #search-results, #autocomplete-results { /* Aplicar estilos a ambos */
              list-style: none;
              padding: 0;
              margin-top: 0.25rem;
              border: 1px solid #ddd;
              border-radius: 0.25rem;
              max-height: 150px;
              overflow-y: auto;
              background-color: #fff;
               /* Oculto por defecto */
               display: none;
               position: absolute; /* Posicionar absolutamente */
               width: calc(100% - 3rem); /* Ancho ajustado al padding del card */
               z-index: 100; /* Asegurar que este por encima de otros elementos */
          }
           /* Ajuste para posicionamiento relativo en el contenedor padre */
           #view-records-section > div:nth-child(3), /* Contenedor del buscador en Ver Registros */
           #add-record-section > div:first-child { /* Contenedor del nombre en Agregar Registro */
               position: relative;
           }


           #search-results.visible, #autocomplete-results.visible {
               display: block; /* Mostrar cuando se aplica la clase visible */
           }
          #search-results li, #autocomplete-results li { /* Aplicar estilos a ambos */
              padding: 0.5rem 0.75rem;
              cursor: pointer;
              border-bottom: 1px solid #eee;
              transition: background-color 0.2s ease;
          }
           #search-results li:last-child, #autocomplete-results li:last-child { /* Aplicar estilos a ambos */
               border-bottom: none;
           }
          #search-results li:hover, #autocomplete-results li:hover { /* Aplicar estilos a ambos */
              background-color: #f9f9f9;
          }


        /* Estilos para graficos */
        .chart-container {
            margin-top: 1.5rem;
             /* Estilos para hacer los graficos mas pequenos y agradables */
             width: 100%; /* Ocupa todo el width del contenedor padre */
             max-width: 400px; /* Ancho maximo */
             margin-left: auto; /* Centrar */
             margin-right: auto; /* Centrar */
             height: 250px; /* Altura fija para el contenedor del grafico */
        }
         .chart-container canvas {
             max-height: 100%; /* Permitir que el canvas ocupe la altura maxima del contenedor */
             width: 100% !important; /* Forzar ancho al 100% */
             height: auto !important; /* Permitir que la altura se ajuste automaticamente */
        }

         .report-section-item {
             margin-bottom: 2rem; /* Espacio entre secciones de prueba/estatura */
             padding-bottom: 1rem;
             border-bottom: 1px dashed #ccc; /* Separador visual */
         }
         .report-section-item:last-child {
             border-bottom: none; /* No hay separador en el ultimo elemento */
             margin-bottom: 0;
             padding-bottom: 0;
         }
         .report-section-item h3 {
             text-align: center; /* Centrar titulos de seccion */
             margin-bottom: 1rem;
         }

         /* Estilos para la tabla de impresion de lista de alumnos */
         #printable-student-list {
             display: none; /* Oculto por defecto */
             width: 100%;
             border-collapse: collapse;
             margin-top: 20px;
         }
         #printable-student-list th,
         #printable-student-list td {
             border: 1px solid #ddd;
             padding: 8px;
             text-align: left;
         }
         #printable-student-list th {
             background-color: #f2f2f2;
         }

        /* Estilos para la distribucion de tabla y grafico en la ficha */
        .report-content-row {
            display: flex; /* Usar flexbox */
            flex-direction: column; /* Por defecto en columnas para pantallas pequenas */
            gap: 1.5rem; /* Espacio entre tabla y grafico */
        }

        @media (min-width: 768px) { /* Aplicar a partir de tamano md (Tailwind) */
            .report-content-row {
                flex-direction: row; /* En filas para pantallas medianas y grandes */
            }
            .report-content-row > div {
                 width: 50%; /* Cada columna ocupa la mitad */
            }
             /* Ajustar el margen del grafico para que no se centre cuando esta al lado de la tabla */
             .report-content-row .chart-container {
                 margin-left: 0;
                 margin-right: 0;
             }
        }

         /* Estilos para la seccion de comparativo */
         #comparison-results > div:first-child { /* Contenedor principal de resultados del comparativo */
             position: relative; /* Para posicionar el promedio */
         }

         #comparison-results h3 {
             display: inline-block; /* Para que el promedio se alinee al lado */
             margin-right: 1rem; /* Espacio entre titulo y promedio */
         }

         #average-result-container {
             display: inline-block; /* Para que este al lado del titulo */
             vertical-align: middle; /* Alinear verticalmente con el titulo */
             background-color: #e9ecef; /* Fondo gris claro */
             border-radius: 0.5rem;
             padding: 0.5rem 1rem; /* Padding */
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
             font-weight: bold;
             color: #007bff; /* Azul */
             font-size: 1rem; /* Tamano de fuente */
         }

         #comparison-table {
             margin-top: 1rem; /* Espacio entre el titulo/promedio y la tabla */
         }

         /* Estilos para el resumen de comparacion avanzada */
         #advanced-comparison-summary {
             margin-top: 2rem;
             padding-top: 1.5rem;
             border-top: 1px solid #ddd;
         }
         #advanced-comparison-summary h4 {
             font-size: 1.2rem;
             font-weight: 600;
             margin-bottom: 1rem;
         }
         #advanced-comparison-summary ul {
             list-style: none;
             padding: 0;
         }
         #advanced-comparison-summary li {
             background-color: #f9f9f9;
             border: 1px solid #eee;
             border-radius: 0.25rem;
             padding: 0.75rem;
             margin-bottom: 0.5rem;
         }
         #advanced-comparison-summary li strong {
             color: #4a90e2; /* Azul */
         }

         /* Estilos para el contenedor del grafico de comparacion */
         #comparison-chart-container {
             margin-top: 2rem;
             width: 100%; /* Ocupa todo el ancho */
             max-width: 600px; /* Ancho maximo para el grafico */
             margin-left: auto;
             margin-right: auto;
             height: 300px; /* Altura del contenedor del grafico */
         }
          #comparison-chart-container canvas {
              max-height: 100%;
              width: 100% !important;
              height: auto !important;
          }

         /* Estilos para el nuevo multi-select con checkboxes */
         .multi-select-container {
             position: relative; /* Para posicionar el dropdown */
         }
         .multi-select-input {
             cursor: pointer; /* Indica que es clickeable */
             background-color: #fff;
             padding-right: 2rem; /* Espacio para el icono */
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 0 01-1.414 0l-4-4a1 0 010-1.414z' clip-rule='evenodd' /%3E%3Csvg%3E"); /* Icono de flecha hacia abajo */
             background-repeat: no-repeat;
             background-position: right 0.5rem center;
             background-size: 1.5em;
         }
         .multi-select-dropdown {
             position: absolute;
             top: 100%; /* Debajo del input */
             left: 0;
             right: 0;
             z-index: 50; /* Por encima de otros elementos */
             background-color: #fff;
             border: 1px solid #ddd;
             border-radius: 0.25rem;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             max-height: 200px;
             overflow-y: auto;
             padding: 0.5rem;
             display: none; /* Oculto por defecto */
         }
         .multi-select-dropdown.visible {
             display: block; /* Mostrar cuando es visible */
         }
         .multi-select-dropdown label {
             display: block; /* Cada opcion en una linea */
             padding: 0.25rem 0.5rem;
             cursor: pointer;
         }
         .multi-select-dropdown label:hover {
             background-color: #f2f2f2;
         }
         .multi-select-dropdown input[type="checkbox"] {
             margin-right: 0.5rem;
         }

        /* Estilos para la seccion de datos del alumno y analisis */
        #student-data-and-analysis {
            display: flex; /* Usar flexbox */
            flex-direction: column; /* Por defecto en columnas para pantallas pequenas */
            gap: 1.5rem; /* Espacio entre las dos columnas */
        }

        #student-data-display {
             width: 100%; /* Ocupa todo el ancho en movil */
        }
         #student-analysis {
             width: 100%; /* Ocupa todo el ancho en movil */
             /* gap: 1.5rem; /* Espacio entre las sub-secciones de analisis - Removido para controlar gap con margin-bottom en las filas */
         }
          #student-analysis > .analysis-titles { /* Contenedor de titulos de analisis (usando grid para alinear con las filas de analisis) */
               width: 100%; /* Ocupan todo el ancho */
               display: grid; /* Usar grid para los titulos */
               grid-template-columns: 1fr 1fr; /* Dos columnas iguales */
               gap: 1.5rem; /* Espacio entre columnas de titulos */
               margin-bottom: 1rem; /* Espacio debajo de los titulos */
          }
           #student-analysis > .analysis-titles > div {
               width: 100%; /* Asegurar que los divs dentro del grid ocupen el ancho */
           }
           #student-analysis > .analysis-titles h4 {
               margin-bottom: 0; /* Eliminar margen inferior del titulo */
               border-bottom: none; /* Eliminar borde inferior del titulo */
               padding-bottom: 0; /* Eliminar padding inferior del titulo */
           }


         /* Contenedor para cada par de analisis (promedio + ranking) por prueba */
         .analysis-item-row {
             display: flex; /* Usar flexbox */
             flex-direction: column; /* Por defecto en columnas para pantallas pequenas */
             gap: 1rem; /* Espacio entre analisis de promedio y ranking */
             margin-bottom: 1rem; /* Espacio entre filas de pruebas */
             padding-bottom: 0.5rem;
             border-bottom: 1px dashed #eee; /* Separador visual */
         }
          .analysis-item-row:last-child {
              border-bottom: none; /* Sin borde en el ultimo elemento */
          }
         .analysis-item-row > div { /* Contenedores individuales dentro de la fila (promedio y ranking) */
             width: 100%; /* Ocupan todo el ancho en movil */
         }

         /* Estilos para el mensaje de evolucion */
         .evolution-message-container { /* Nuevo contenedor para el mensaje de evolucion */
              margin-top: 0.5rem; /* Espacio arriba */
              padding: 0.5rem;
              border-radius: 0.25rem;
              font-size: 0.9rem;
              width: 100%; /* Ocupa todo el ancho disponible */
         }
          .evolution-message-container.positive {
              background-color: #d4edda; /* Verde claro */
              border: 1px solid #c3e6cb;
              color: #155724; /* Verde oscuro */
          }
           .evolution-message-container.negative {
              background-color: #f8d7da; /* Rojo claro */
              border: 1px solid #f5c6cb;
              color: #721c24; /* Rojo oscuro */
           }


        @media (min-width: 768px) { /* Aplicar a partir de tamano md (Tailwind) */
            #student-data-and-analysis {
                flex-direction: row; /* En filas para pantallas medianas y grandes */
            }
            #student-data-display {
                width: 50%; /* Ocupa la mitad en desktop */
            }
             #student-analysis {
                 width: 50%; /* Ocupa la mitad en desktop */
             }
              #student-analysis > .analysis-titles {
                   gap: 1.5rem; /* Mantener el mismo gap que las filas de analisis */
              }
             .analysis-item-row {
                  flex-direction: row; /* En filas para pantallas medianas y grandes */
                  gap: 1.5rem; /* Espacio entre columnas de analisis */
             }
             .analysis-item-row > div { /* Contenedores individuales dentro de la fila (promedio y ranking) */
                 width: 50%; /* Cada analisis ocupa la mitad en desktop */
             }
              .evolution-message-container { /* Estilos para desktop */
                   width: 100%; /* Sigue ocupando todo el ancho en desktop */
              }
        }

        /* Estilos para la seccion de analisis */
        #student-analysis h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        #student-analysis ul {
            list-style: none;
            padding: 0;
        }
        #student-analysis li {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        /* Estilos para analisis por promedio de edad */
        /* Aplicados a los divs dentro de .analysis-item-row */
         .analysis-item-row .strength {
            background-color: #e9f7ef; /* Verde claro */
            border: 1px solid #d0e9d7;
            color: #28a745; /* Verde oscuro */
            padding: 0.75rem; /* Anadir padding para que se vea como una tarjeta */
            border-radius: 0.25rem; /* Anadir borde redondeado */
         }
          .analysis-item-row .weakness {
            background-color: #fdedee; /* Rojo claro */
            border: 1px solid #fbcbd2;
            color: #dc3545; /* Rojo oscuro */
             padding: 0.75rem; /* Anadir padding para que se vea como una tarjeta */
            border-radius: 0.25rem; /* Anadir borde redondeado */
         }
          .analysis-item-row .neutral {
            background-color: #f8f9fa; /* Gris muy claro */
            border: 1px solid #e9ecef;
            color: #6c757d; /* Gris */
             padding: 0.75rem; /* Anadir padding para que se vea como una tarjeta */
            border-radius: 0.25rem; /* Anadir borde redondeado */
         }
        /* Estilos para analisis de ranking (sin fondo de color en el li) */
         /* Aplicados a los divs dentro de .analysis-item-row */
         .analysis-item-row .ranking-item {
             background-color: transparent; /* Fondo transparente */
             border: none; /* Sin borde */
             padding: 0.75rem; /* Restaurar padding para que se alinee con los otros */
             margin-bottom: 0; /* Espacio reducido */
             border-radius: 0.25rem; /* Anadir borde redondeado */
              border: 1px solid #e9ecef; /* Anadir borde gris claro */
              background-color: #f8f9fa; /* Anadir fondo gris claro */
         }
         /* Estilos para los iconos de ranking individual */
         .analysis-item-row .ranking-item i.fa-star {
             color: #f39c12; /* Amarillo/Naranja para talento individual */
         }
          .analysis-item-row .ranking-item i.fa-medal {
             color: #95a5a6; /* Gris para distincion individual */
          }


         /* Estilos para las nuevas distinciones olimpicas generales */
         #general-olympic-distinctions li { /* Aplicar a los li en la nueva lista */
             font-weight: bold;
             padding: 0.75rem; /* Restaurar padding para estas distinciones */
             margin-bottom: 0.5rem; /* Restaurar margen para estas distinciones */
             border-radius: 0.25rem; /* Restaurar borde redondeado */
         }
          #general-olympic-distinctions i.fa-medal.gold {
             color: #FFD700; /* Oro */
         }
          #general-olympic-distinctions i.fa-trophy.gold {
             color: #FFD700; /* Oro */
         }
          #general-olympic-distinctions li.double-gold {
               background-color: #fff3cd; /* Amarillo claro */
               border: 1px solid #ffeeba;
               color: #856404; /* Amarillo oscuro */
          }
          #general-olympic-distinctions li.triple-crown {
               background-color: #d4edda; /* Verde muy claro */
               border: 1px solid #c3e6cb;
               color: #155724; /* Verde oscuro */
          }
          #general-olympic-distinctions li.quad-crown { /* Nueva clase para 4+ Top 5 */
               background-color: #cfe2ff; /* Azul muy claro */
               border: 1px solid #b9d1ea;
               color: #084298; /* Azul oscuro */
          }

         /* Estilos para los iconos al lado del nombre (Top 1 en 3+ pruebas) */
         #selected-student-name-display .top1-distinction-icons {
             margin-left: 0.5rem; /* Espacio entre el nombre y los iconos */
             vertical-align: middle; /* Alinear verticalmente */
         }
          #selected-student-name-display .top1-distinction-icons i.fa-crown {
              color: #FFD700; /* Dorado */
          }
           #selected-student-name-display .top1-distinction-icons i.fa-gem {
              color: #17a2b8; /* Turquesa */
           }


         #student-analysis li strong {
             margin-right: 0.5rem;
         }


        @media print {
            body * {
                visibility: hidden;
            }
            #report-section, #report-section * {
                visibility: visible;
            }
             #comparison-section, #comparison-section * {
                visibility: visible;
                 /* Asegurar que la tabla y estadisticas del comparativo se muestren */
                 display: block !important; /* Anular flexbox en impresion si se usara */
             }
             #comparison-results {
                 display: block !important; /* Anular flexbox en impresion si se usara */
             }
              #comparison-results > div {
                   width: 100% !important; /* Ocupa todo el ancho en impresion */
              }
             #average-result-container {
                 display: block !important; /* Mostrar como bloque en impresion */
                 margin-bottom: 1rem; /* Espacio debajo en impresion */
                 text-align: left !important; /* Alinear texto a la izquierda en impresion */
                 padding: 0.25rem 0.5rem; /* Padding mas pequeno en impresion */
                 box-shadow: none !important; /* Sin sombra en impresion */
             }
             #comparison-results h3 {
                 display: block !important; /* Mostrar como bloque en impresion */
                 margin-right: 0 !important; /* Eliminar margen a la derecha en impresion */
                 margin-bottom: 0.5rem !important; /* Espacio debajo del titulo en impresion */
             }

             #advanced-comparison-summary {
                  display: block !important; /* Asegurar que se muestre en impresion */
                  margin-top: 1rem !important;
                  padding-top: 0.5rem !important;
                  border-top: 1px solid #ddd !important;
             }
             #advanced-comparison-summary h4 {
                  font-size: 1rem !important;
                  margin-bottom: 0.5rem !important;
             }
             #advanced-comparison-summary ul {
                  padding-left: 1rem !important; /* Anadir padding para la lista en impresion */
             }
             #advanced-comparison-summary li {
                 background-color: transparent !important; /* Fondo transparente en impresion */
                 border: none !important; /* Sin borde en impresion */
                 padding: 0.25rem 0 !important; /* Padding reducido en impresion */
                 margin-bottom: 0.25rem !important; /* Espacio reducido en impresion */
             }

             #comparison-chart-container {
                  display: block !important; /* Asegurar que se muestre en impresion */
                  margin-top: 1rem !important;
                  width: 100% !important; /* Ocupa todo el ancho en impresion */
                  max-width: none !important; /* Eliminar ancho maximo en impresion */
                  height: auto !important; /* Altura automatica en impresion */
             }
             #comparison-chart-container canvas {
                  width: 100% !important;
                  height: auto !important;
             }

             #student-data-and-analysis {
                  display: block !important; /* Anular flexbox en impresion */
             }
             #student-data-display, #student-analysis {
                  width: 100% !important; /* Ocupan todo el ancho en impresion */
                  margin-bottom: 1rem; /* Espacio entre secciones en impresion */
             }
              #student-analysis {
                   margin-top: 1rem; /* Espacio arriba en impresion */
                   border-top: 1px solid #ddd; /* Separador visual en impresion */
                   padding-top: 1rem;
                    display: block !important; /* Anular flexbox en impresion */
                    gap: 0 !important; /* Eliminar gap en impresion */
              }
              /* Ajustes para la nueva estructura de analisis por prueba en impresion */
              #student-analysis > .analysis-titles {
                  display: block !important; /* Apilar titulos en impresion */
                  gap: 0 !important;
                  margin-bottom: 0.5rem !important;
              }
              #student-analysis > .analysis-titles > div {
                  width: 100% !important;
                  margin-bottom: 0.25rem !important;
              }
               #student-analysis > .analysis-titles h4 {
                   border-bottom: none !important;
                   padding-bottom: 0 !important;
                   margin-bottom: 0 !important;
               }

              .analysis-item-row {
                  display: block !important; /* Apilar en impresion */
                  gap: 0 !important;
                  margin-bottom: 0.5rem !important;
                  padding-bottom: 0.25rem !important;
                  border-bottom: 1px dashed #eee !important;
              }
              .analysis-item-row > div { /* Contenedores individuales dentro de la fila */
                  width: 100% !important;
                  margin-bottom: 0.25rem !important;
              }
              .analysis-item-row .ranking-item {
                  padding: 0 !important; /* Eliminar padding en impresion */
                  margin-bottom: 0 !important; /* Eliminar margen en impresion */
              }
               #general-olympic-distinctions li {
                   background-color: transparent !important;
                   border: none !important;
                   padding: 0.1rem 0 !important;
                   margin-bottom: 0.1rem !important;
               }

               .evolution-message-container { /* Estilos para impresion */
                    margin-top: 0.25rem !important;
                    padding: 0.25rem !important;
                    font-size: 0.8rem !important;
                    background-color: transparent !important;
                    border: none !important;
                    color: inherit !important; /* Usar color de texto normal */
               }


              #student-analysis ul {
                   padding-left: 1rem !important; /* Anadir padding para la lista en impresion */
              }
              #student-analysis li {
                  background-color: transparent !important; /* Fondo transparente en impresion */
                  border: none !important; /* Sin borde en impresion */
                  padding: 0.1rem 0 !important; /* Padding reducido en impresion */
                  margin-bottom: 0.1rem !important; /* Espacio reducido en impresion */
              }
              /* Asegurar que los iconos al lado del nombre se muestren */
              #selected-student-name-display .top1-distinction-icons {
                  display: inline !important;
                  margin-left: 0.2rem !important;
              }


             #printable-student-list, #printable-student-list * { /* Hacer visible la tabla de impresion */
                 visibility: visible;
             }

            .print-button, .generate-button, .compare-button, .delete-button, .import-button, .export-button, #search-input, #search-results, .navbar, #view-records-section .grid, #view-records-section button:not(.print-list-button), #view-records-section label, #view-records-section select, #view-records-section input:not(#search-input), .back-button, .app-footer, #autocomplete-results, .inline-action-btn, #student-data-display button { /* Oculta elementos de UI, barra de navegacion, footer y botones de accion inline en la impresion */
                display: none;
            }
             /* Asegura que los graficos se muestren correctamente en la impresion */
            .chart-container {
                page-break-inside: avoid;
                 width: 50% !important; /* Forzar ancho al 50% en impresion */
                 height: auto !important; /* Permitir que la altura se ajuste */
                 margin: 0 !important; /* Eliminar margen */
            }
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
             /* Asegura que las tablas individuales se muestren en la impresion */
             .report-section-item table {
                 display: table;
                 width: 50% !important; /* Forzar ancho al 50% en impresion */
             }

             /* Asegurar que la fila de contenido del reporte use flexbox en impresion */
             .report-content-row {
                 display: flex;
                 flex-direction: row; /* Forzar a fila en impresion */
                 gap: 1rem; /* Espacio entre columnas en impresion */
             }
             /* Asegurar que las celdas de accion no se muestren en la impresion */
             .report-section-item table td:last-child,
             .report-section-item table th:last-child {
                 display: none;
             }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container mx-auto">
            <a href="#" class="navbar-brand">Registro EF</a>
            <ul class="navbar-nav">
                <li><a href="#add-record-section" class="nav-link">Agregar Registro</a></li>
                <li><a href="#view-records-section" class="nav-link">Ver Alumnos</a></li>
                <li><a href="#comparison-section" class="nav-link">Comparativo</a></li>
                 <li><a href="#import-export-section" class="nav-link">Importar/Exportar</a></li> </ul>
        </div>
    </nav>

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">Sistema de Registro de Alumnos de Educacion Fisica</h1>

        <div id="add-record-section" class="card"> <h2 class="text-xl font-semibold mb-4">Agregar Resultado de Prueba Individual</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Nombre del Alumno:</label>
                    <input type="text" id="student-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Escribe el nombre del alumno...">
                    <ul id="autocomplete-results"></ul>
                </div>
                 <div>
                    <label for="student-age" class="block text-sm font-medium text-gray-700">Edad:</label>
                    <input type="number" id="student-age" step="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="student-sex" class="block text-sm font-medium text-gray-700">Sexo:</label>
                    <select id="student-sex" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">-- Seleccionar Sexo --</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                    </select>
                </div>
                 <div>
                    <label for="student-height" class="block text-sm font-medium text-gray-700">Estatura (cm):</label>
                    <input type="number" id="student-height" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="student-course" class="block text-sm font-medium text-gray-700">Curso:</label>
                    <input type="text" id="student-course" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                 <div>
                    <label for="student-school" class="block text-sm font-medium text-gray-700">Escuela:</label>
                    <select id="student-school" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">-- Seleccionar Escuela --</option>
                        <option value="EEP9">EEP9</option>
                        <option value="EEST3">EEST3</option>
                        <option value="EEP2">EEP2</option>
                        <option value="EEST1">EEST1</option>
                        <option value="EES5">EES5</option>
                    </select>
                </div>
                 <div>
                    <label for="student-district" class="block text-sm font-medium text-gray-700">Distrito:</label>
                    <select id="student-district" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">-- Seleccionar Distrito --</option>
                        <option value="Vicente Lopez">Vicente Lopez</option>
                        <option value="San Isidro">San Isidro</option>
                    </select>
                </div>
                <div>
                    <label for="test-type" class="block text-sm font-medium text-gray-700">Tipo de Prueba:</label>
                    <select id="test-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">-- Seleccionar Prueba --</option>
                        <option value="speed30m">Velocidad 30m</option>
                        <option value="situps30s">Abdominales Rectos 30s</option>
                        <option value="obliqueSitups30s">Abdominales Inferiores 30s</option>
                        <option value="longJump">Salto Largo</option>
                        <option value="flexibility">Flexibilidad</option>
                         <option value="ropeJumps1min">Saltos con soga en 1 min</option>
                         <option value="run500m">500 metros</option>
                         <option value="pushups30s">Flexiones en 30 segundos</option>
                    </select>
                </div>
                <div>
                    <label for="record-date" class="block text-sm font-medium text-gray-700">Fecha:</label>
                    <input type="date" id="record-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="test-result" class="block text-sm font-medium text-gray-700">Resultado:</label>
                    <input type="number" id="test-result" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
            </div>
            <button id="add-record-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Agregar Resultado</button>
        </div>

         <div id="import-export-section" class="card"> <h2 class="text-xl font-semibold mb-4">Exportar / Importar Datos</h2>
             <div class="flex flex-wrap gap-4">
                 <button id="export-json-btn" class="export-button">Exportar Datos (JSON)</button>
                 <button id="export-csv-btn" class="export-button">Exportar Datos (CSV)</button>
                 <input type="file" id="import-file-input" accept=".json, .csv" class="hidden">
                 <button id="import-data-btn" class="import-button">Importar Datos</button>
             </div>
         </div>


        <div id="view-records-section" class="card"> <h2 class="text-xl font-semibold mb-4">Ver Registros y Evolucion por Alumno</h2>

            <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Filtros Avanzados</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="view-filter-age" class="block text-sm font-medium text-gray-700">Filtrar por Edad:</label>
                        <select id="view-filter-age" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Todas las Edades</option>
                            </select>
                    </div>
                    <div>
                        <label for="view-filter-sex" class="block text-sm font-medium text-gray-700">Filtrar por Sexo:</label>
                    <select id="view-filter-sex" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todos los Sexos</option>
                        <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                    </select>
                </div>
                 <div>
                    <label for="view-filter-course" class="block text-sm font-medium text-gray-700">Filtrar por Curso:</label>
                    <select id="view-filter-course" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todos los Cursos</option>
                        </select>
                </div>
                 <div>
                    <label for="view-filter-school" class="block text-sm font-medium text-gray-700">Filtrar por Escuela:</label>
                     <select id="view-filter-school" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todas las Escuelas</option>
                        <option value="EEP9">EEP9</option>
                        <option value="EEST3">EEST3</option>
                        <option value="EEP2">EEP2</option>
                        <option value="EEST1">EEST1</option>
                        <option value="EES5">EES5</option>
                    </select>
                </div>
                 <div>
                    <label for="view-filter-district" class="block text-sm font-medium text-gray-700">Filtrar por Distrito:</label>
                    <select id="view-filter-district" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todos los Distritos</option>
                        <option value="Vicente Lopez">Vicente Lopez</option>
                        <option value="San Isidro">San Isidro</option>
                    </select>
                </div>
                 <div>
                    <label for="view-filter-height" class="block text-sm font-medium text-gray-700">Altura Minima (cm):</label>
                    <input type="number" id="view-filter-height" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Ej: 150">
                </div>
            </div>
                 <button id="apply-view-filters-btn" class="mt-4 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Aplicar Filtros</button> <button id="print-filtered-list-btn" class="mt-4 print-list-button">Imprimir Lista Filtrada</button> </div>


            <div>
                <label for="search-input" class="block text-sm font-medium text-gray-700">Buscar Alumno por Nombre, Curso, Escuela o Distrito:</label>
                <input type="text" id="search-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Escribe el nombre, curso, escuela o distrito...">
                <ul id="search-results"></ul> </div>
            <div class="mt-4"> <label for="select-student" class="block text-sm font-medium text-gray-700">O Seleccionar Alumno de la Lista (filtrada):</label>
                <select id="select-student" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    <option value="">-- Seleccionar Alumno --</option>
                </select>
            </div>

            <div id="student-records" class="mt-6 hidden" data-current-student-identity=""> <h3 class="text-lg font-semibold mb-4">Datos del Alumno: <span id="selected-student-name-display" class="text-blue-700"></span></h3> <div id="student-data-and-analysis">
                     <div id="student-data-display">
                         <p class="mb-2"><strong>Edad:</strong> <span id="student-age-display">-</span></p>
                         <p class="mb-2"><strong>Sexo:</strong> <span id="student-sex-display">-</span></p>
                         <p class="mb-2"><strong>Estatura:</strong> <span id="student-height-display">-</span> cm</p>
                         <p class="mb-2"><strong>Curso:</strong> <span id="student-course-display">-</span></p>
                         <p class="mb-2"><strong>Escuela:</strong> <span id="student-school-display">-</span></p>
                         <p class="mb-2"><strong>Distrito:</strong> <span id="student-district-display">-</span></p>
                          <button id="edit-student-data-btn" class="mt-4 bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Editar Datos del Alumno</button>
                     </div>

                     <div id="student-analysis">
                          <div class="analysis-titles">
                              <div>
                                  <h4>Analisis del Alumno</h4> </div>
                              <div>
                                  <h4>Ranking</h4> </div>
                          </div>
                           <ul id="general-olympic-distinctions" class="mb-4">
                               </ul>

                          <div id="analysis-rows-container">
                              <!-- Example structure:
                              <div class="analysis-item-row">
                                  <div class="strength">...</div>
                                  <div class="ranking-item">...</div>
                              </div>
                              <div class="evolution-message-container positive">...</div> -->
                          </div>
                     </div>

                     <div id="student-data-edit" class="hidden">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label for="student-name-edit" class="block text-sm font-medium text-gray-700">Nombre:</label>
                                <input type="text" id="student-name-edit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                             </div>
                              <div>
                                <label for="student-age-edit" class="block text-sm font-medium text-gray-700">Edad:</label>
                                <input type="number" id="student-age-edit" step="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                             </div>
                              <div>
                                <label for="student-sex-edit" class="block text-sm font-medium text-gray-700">Sexo:</label>
                                <select id="student-sex-edit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="masculino">Masculino</option>
                                    <option value="femenino">Femenino</option>
                                </select>
                             </div>
                              <div>
                                <label for="student-height-edit" class="block text-sm font-medium text-gray-700">Estatura (cm):</label>
                                <input type="number" id="student-height-edit" step="0.1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                             </div>
                              <div>
                                <label for="student-course-edit" class="block text-sm font-medium text-gray-700">Curso:</label>
                                <input type="text" id="student-course-edit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                             </div>
                              <div>
                                <label for="student-school-edit" class="block text-sm font-medium text-gray-700">Escuela:</label>
                                <select id="student-school-edit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="EEP9">EEP9</option>
                                    <option value="EEST3">EEST3</option>
                                    <option value="EEP2">EEP2</option>
                                    <option value="EEST1">EEST1</option>
                                    <option value="EES5">EES5</option>
                                </select>
                             </div>
                              <div>
                                <label for="student-district-edit" class="block text-sm font-medium text-gray-700">Distrito:</label>
                                <select id="student-district-edit" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="Vicente Lopez">Vicente Lopez</option>
                                    <option value="San Isidro">San Isidro</option>
                                </select>
                             </div>
                         </div>
                         <button id="save-student-data-btn" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mr-2">Guardar Cambios</button>
                         <button id="cancel-student-data-btn" class="mt-4 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                     </div>
                 </div>


                <h3 class="text-lg font-semibold mt-6 mb-4">Registros de Pruebas</h3> <table id="records-table" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo de Prueba</th>
                            <th>Resultado</th>
                            <th>Ciclo Lectivo</th> <th>Acciones</th> </tr>
                    </thead>
                    <tbody id="records-table-body">
                        </tbody>
                </table>
                <button id="delete-student-btn" class="mt-4 delete-button">Eliminar Alumno Completo</button>
                <button id="generate-report-btn" class="mt-4 generate-button">Generar Ficha del Alumno</button>
            </div>
        </div>

        <div id="comparison-section" class="card"> <h2 class="text-xl font-semibold mb-4">Comparativo entre Alumnos</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="filter-age" class="block text-sm font-medium text-gray-700">Filtrar por Edad:</label>
                    <select id="filter-age" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todas las Edades</option>
                        </select>
                </div>
                <div>
                    <label for="filter-sex" class="block text-sm font-medium text-gray-700">Filtrar por Sexo:</label>
                    <select id="filter-sex" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todos los Sexos</option>
                         <option value="masculino">Masculino</option>
                        <option value="femenino">Femenino</option>
                        </select>
                </div>
                 <div>
                    <label for="filter-course" class="block text-sm font-medium text-gray-700">Filtrar por Curso:</label>
                    <select id="filter-course" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">Todos los Cursos</option>
                        </select>
                </div>
                 <div class="multi-select-container">
                    <label for="filter-school-input" class="block text-sm font-medium text-gray-700">Filtrar por Escuela(s):</label>
                    <input type="text" id="filter-school-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 multi-select-input" readonly placeholder="Seleccionar Escuela(s)">
                    <div id="filter-school-dropdown" class="multi-select-dropdown">
                        <label><input type="checkbox" value=""> Todas las Escuelas</label>
                        </div>
                 </div>
                 <div class="multi-select-container">
                    <label for="filter-district-input" class="block text-sm font-medium text-gray-700">Filtrar por Distrito(s):</label>
                    <input type="text" id="filter-district-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 multi-select-input" readonly placeholder="Seleccionar Distrito(s)">
                     <div id="filter-district-dropdown" class="multi-select-dropdown">
                         <label><input type="checkbox" value=""> Todos los Distritos</label>
                         </div>
                 </div>

                 <div>
                    <label for="filter-test-type" class="block text-sm font-medium text-gray-700">Filtrar por Prueba:</label>
                    <select id="filter-test-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        <option value="">-- Seleccionar Prueba --</option>
                         <option value="speed30m">Velocidad 30m</option>
                        <option value="situps30s">Abdominales Rectos 30s</option>
                         <option value="obliqueSitups30s">Abdominales Inferiores 30s</option>
                        <option value="longJump">Salto Largo</option>
                        <option value="flexibility">Flexibilidad</option>
                         <option value="ropeJumps1min">Saltos con soga en 1 min</option>
                         <option value="run500m">500 metros</option>
                         <option value="pushups30s">Flexiones en 30 segundos</option>
                    </select>
                </div>
            </div>
            <button id="show-comparison-btn" class="mt-4 w-full compare-button">Mostrar Comparativo</button>

            <div id="comparison-results" class="mt-6 hidden">
                 <div>
                    <h3 class="text-lg font-semibold mb-4">Resultados del Comparativo</h3>
                     <span id="average-result-container">Promedio: <span id="average-result">-</span></span>

                     <div id="advanced-comparison-summary" class="hidden">
                         <h4>Resumen Comparativo por Grupo</h4>
                         <ul id="summary-list">
                             </ul>
                     </div>

                     <div id="comparison-chart-container" class="hidden">
                         <canvas id="comparison-chart"></canvas>
                     </div>


                     <table id="comparison-table" class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th data-sort="name">Nombre</th>
                                <th data-sort="age">Edad</th>
                                <th data-sort="sex">Sexo</th>
                                <th data-sort="course">Curso</th>
                                <th data-sort="school">Escuela</th>
                                <th data-sort="district">Distrito</th>
                                <th data-sort="date">Fecha del Resultado</th>
                                <th data-sort="academicYear">Ciclo Lectivo</th> <th data-sort="result">Resultado</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div id="report-section" class="card hidden">
            <h2 class="text-xl font-semibold mb-4">Ficha del Alumno: <span id="report-student-name" class="text-blue-700"></span></h2>
            <p class="mb-2"><strong>Fecha de Generacion:</strong> <span id="report-date"></span></p>
             <p class="mb-2"><strong>Edad:</strong> <span id="report-student-age">-</span></p>
            <p class="mb-2"><strong>Sexo:</strong> <span id="report-student-sex">-</span></p>
            <p class="mb-2"><strong>Estatura:</strong> <span id="report-student-height">-</span> cm</p>
             <p class="mb-2"><strong>Curso:</strong> <span id="report-student-course">-</span></p>
            <p class="mb-2"><strong>Escuela:</strong> <span id="report-school">-</span></p> <p class="mb-2"><strong>Distrito:</strong> <span id="report-district">-</span></p> <p class="mb-4"><strong>Ciclo Lectivo:</strong> <span id="report-academic-year">-</span></p> <div id="individual-results-container">
                </div>

            <h3 class="text-lg font-semibold mt-6 mb-4">Analisis de Evolucion</h3>
            <div id="evolution-analysis">
                </div>

            <button id="print-report-btn" class="mt-4 print-button">Imprimir Ficha</button>
        </div>

         <table id="printable-student-list">
             <thead>
                 <tr>
                     <th>Nombre</th>
                     <th>Edad</th>
                     <th>Sexo</th>
                     <th>Estatura (cm)</th>
                     <th>Curso</th>
                     <th>Escuela</th>
                     <th>Distrito</th>
                     <th>Ciclo Lectivo</th> </tr>
             </thead>
             <tbody>
                 </tbody>
         </table>

    </div>

    <button id="back-button" class="fixed bottom-4 right-4 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded shadow" disabled>Atras</button>

    <footer class="text-center py-4 text-gray-600 text-sm">
        Disenada por el Profesor Nacional de Educacion Fisica Esteban Quintero
    </footer>


    <script>
        // Array para almacenar todos los registros (ahora resultados individuales)
        // Se actualiza la clave de localStorage para evitar conflictos con versiones anteriores
        let allRecords = JSON.parse(localStorage.getItem('physicalEducationRecordsIndividualV59')) || [];
        let chartInstances = {}; // Para almacenar las instancias de los graficos

        // Variables para el estado de ordenamiento
        let currentComparisonSortColumn = 'result'; // Columna de ordenamiento por defecto en comparativo (siempre resultado)
        let currentComparisonSortDirection = 'desc'; // Direccion de ordenamiento por defecto en comparativo (mejor resultado primero)

        // Variables para el historial de navegacion
         // Inicializar el historial con la seccion actual si no esta vacio
         let navigationHistory = JSON.parse(sessionStorage.getItem('navigationHistory')) || [];
         let currentSectionId = sessionStorage.getItem('currentSectionId') || 'add-record-section'; // Seccion inicial

         // Variable para almacenar la lista de alumnos filtrada en la seccion Ver Registros
         let filteredStudentList = [];

         // Variable para rastrear la fila que se esta editando actualmente (para edicion inline)
         let editingRow = null;
         let editingId = null; // Store the ID of the record being edited

         // Umbrales para fortalezas y debilidades (porcentaje de diferencia con el promedio de la misma edad)
         const STRENGTH_THRESHOLD_PERCENTAGE = 15; // Considerar fortaleza si esta 15% o mas arriba del promedio
         const WEAKNESS_THRESHOLD_PERCENTAGE = 15; // Considerar debilidad si esta 15% o mas abajo del promedio

         // Umbral minimo de participantes para mostrar ranking
         const MIN_PARTICIPANTS_FOR_RANKING = 10;

         // Umbral para el analisis de evolucion (porcentaje de diferencia entre las dos ultimas fechas)
         const EVOLUTION_THRESHOLD_PERCENTAGE = 5; // Considerar mejora/empeoramiento significativo si cambia un 5% o mas


        // Elementos del DOM - Agregar Registro
        const addRecordSection = document.getElementById('add-record-section');
        const studentNameInput = document.getElementById('student-name');
        const autocompleteResultsUl = document.getElementById('autocomplete-results'); // Nueva lista para autocompletado
        const studentAgeInput = document.getElementById('student-age');
        const studentSexSelect = document.getElementById('student-sex');
        const studentHeightInput = document.getElementById('student-height');
        const studentCourseInput = document.getElementById('student-course');
        const studentSchoolSelect = document.getElementById('student-school');
        const studentDistrictSelect = document.getElementById('student-district');
        const testTypeSelect = document.getElementById('test-type');
        const recordDateInput = document.getElementById('record-date');
        const testResultInput = document.getElementById('test-result');
        const addRecordBtn = document.getElementById('add-record-btn');

        // Elementos del DOM - Exportar/Importar
        const importExportSection = document.getElementById('import-export-section');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importDataBtn = document.getElementById('import-data-btn');


        // Elementos del DOM - Ver Registros por Alumno
        const viewRecordsSection = document.getElementById('view-records-section');
        const viewFilterAgeSelect = document.getElementById('view-filter-age'); // Nuevo filtro
        const viewFilterSexSelect = document.getElementById('view-filter-sex'); // Nuevo filtro
        const viewFilterCourseSelect = document.getElementById('view-filter-course'); // Nuevo filtro
        const viewFilterSchoolSelect = document.getElementById('view-filter-school'); // Nuevo filtro
        const viewFilterDistrictSelect = document.getElementById('view-filter-district'); // Nuevo filtro
        const viewFilterHeightInput = document.getElementById('view-filter-height'); // Nuevo filtro de estatura
        const applyViewFiltersBtn = document.getElementById('apply-view-filters-btn'); // Nuevo boton de filtro
        const printFilteredListBtn = document.getElementById('print-filtered-list-btn'); // Boton de imprimir lista filtrada


        const searchInput = document.getElementById('search-input');
        const searchResultsUl = document.getElementById('search-results');
        const selectStudentSelect = document.getElementById('select-student');
        const studentRecordsDiv = document.getElementById('student-records');

        // Elementos del DOM - Datos del Alumno en Ver Registros
        const selectedStudentNameDisplay = document.getElementById('selected-student-name-display');
        const studentDataAndAnalysisDiv = document.getElementById('student-data-and-analysis'); // Contenedor flexbox
        const studentDataDisplayDiv = document.getElementById('student-data-display');
        const studentAnalysisDiv = document.getElementById('student-analysis'); // Nuevo div para analisis
        // const analysisListAverageUl = document.getElementById('analysis-list-average'); // Ya no se usa directamente
        // const analysisListRankingUl = document.getElementById('analysis-list-ranking'); // Ya no se usa directamente
        const generalOlympicDistinctionsUl = document.getElementById('general-olympic-distinctions'); // Nueva lista para distinciones generales
        const analysisRowsContainer = document.getElementById('analysis-rows-container'); // Nuevo contenedor para filas de analisis por prueba


        const studentAgeDisplaySpan = document.getElementById('student-age-display');
        const studentSexDisplaySpan = document.getElementById('student-sex-display');
        const studentHeightDisplaySpan = document.getElementById('student-height-display');
        const studentCourseDisplaySpan = document.getElementById('student-course-display');
        const studentSchoolDisplaySpan = document.getElementById('student-school-display');
        const studentDistrictDisplaySpan = document.getElementById('student-district-display');
        const editStudentDataBtn = document.getElementById('edit-student-data-btn');
         const studentRecordsDivData = document.getElementById('student-records'); // Referencia al div principal para data attribute


        // Elementos del DOM - Edicion de Datos del Alumno en Ver Registros
        const studentDataEditDiv = document.getElementById('student-data-edit');
        const studentNameEditInput = document.getElementById('student-name-edit');
        const studentAgeEditInput = document.getElementById('student-age-edit');
        const studentSexEditSelect = document.getElementById('student-sex-edit');
        const studentHeightEditInput = document.getElementById('student-height-edit');
        const studentCourseEditInput = document.getElementById('student-course-edit');
        const studentSchoolEditSelect = document.getElementById('student-school-edit');
        const studentDistrictEditSelect = document.getElementById('student-district-edit');
        const saveStudentDataBtn = document.getElementById('save-student-data-btn');
        const cancelStudentDataBtn = document.getElementById('cancel-student-data-btn');


        const recordsTableBody = document.getElementById('records-table-body');
        const deleteStudentBtn = document.getElementById('delete-student-btn');
        const generateReportBtn = document.getElementById('generate-report-btn');

        // Elementos del DOM - Ficha del Alumno
        const reportSectionDiv = document.getElementById('report-section');
        const reportStudentNameSpan = document.getElementById('report-student-name');
        const reportDateSpan = document.getElementById('report-date');
        // Corregidos los IDs para que coincidan con el HTML
        const reportStudentAgeSpan = document.getElementById('report-student-age');
        const reportStudentSexSpan = document.getElementById('report-student-sex');
        const reportStudentHeightSpan = document.getElementById('report-student-height');
        const reportStudentCourseSpan = document.getElementById('report-student-course');
        const reportStudentSchoolSpan = document.getElementById('report-school');
        const reportStudentDistrictSpan = document.getElementById('report-district');
        const reportAcademicYearSpan = document.getElementById('report-academic-year');


        const individualResultsContainer = document.getElementById('individual-results-container'); // Nuevo contenedor
        const evolutionAnalysisDiv = document.getElementById('evolution-analysis');
        const printReportBtn = document.getElementById('print-report-btn');


         // Elemento para la tabla de impresion de lista
         const printableStudentListTable = document.getElementById('printable-student-list');
         const printableStudentListTableBody = printableStudentListTable.querySelector('tbody');

         // Elemento del boton Atras
         const backButton = document.getElementById('back-button');

         // El formulario de edicion individual separado ya no se usa
         // const editRecordFormContainer = document.getElementById('edit-record-form-container');
         // const editRecordIdInput = document.getElementById('edit-record-id');
         // const editRecordDateInput = document.getElementById('edit-record-date');
         // const editTestTypeSelect = document.getElementById('edit-test-type');
         // const editTestResultInput = document.getElementById('edit-test-result');
         // const saveEditedRecordBtn = document.getElementById('save-edited-record-btn');
         // const cancelEditRecordBtn = document.getElementById('cancel-edit-record-btn');


        // Elementos del DOM - Comparativo
        const comparisonSection = document.getElementById('comparison-section');
        const filterAgeSelect = document.getElementById('filter-age');
        const filterSexSelect = document.getElementById('filter-sex');
        const filterCourseSelect = document.getElementById('filter-course');
        // Nuevos elementos para el multi-select de Escuelas
        const filterSchoolInput = document.getElementById('filter-school-input');
        const filterSchoolDropdown = document.getElementById('filter-school-dropdown');
        // Nuevos elementos para el multi-select de Distritos
        const filterDistrictInput = document.getElementById('filter-district-input');
        const filterDistrictDropdown = document.getElementById('filter-district-dropdown');


        const filterTestTypeSelect = document.getElementById('filter-test-type');
        const showComparisonBtn = document.getElementById('show-comparison-btn');
        const comparisonResultsDiv = document.getElementById('comparison-results');
        const comparisonTableBody = document.getElementById('comparison-table-body');
        const comparisonTableHeaders = document.querySelectorAll('#comparison-table th[data-sort]');
         const averageResultContainer = document.getElementById('average-result-container'); // Contenedor del promedio
         const averageResultSpan = document.getElementById('average-result'); // Span para mostrar el promedio
         const advancedComparisonSummaryDiv = document.getElementById('advanced-comparison-summary'); // Nuevo div para resumen avanzado
         const summaryListUl = document.getElementById('summary-list'); // Lista para el resumen
         const comparisonChartContainer = document.getElementById('comparison-chart-container'); // Contenedor del grafico de comparacion
         const comparisonChartCanvas = document.getElementById('comparison-chart'); // Canvas del grafico de comparacion
         let comparisonChartInstance = null; // Instancia del grafico de comparacion


         // Elementos de navegacion
         const navLinks = document.querySelectorAll('.nav-link');
         const sections = document.querySelectorAll('.card'); // Todas las secciones principales son cards

         // Mapeo de IDs de seccion a elementos del DOM
         const sectionMap = {
             'add-record-section': addRecordSection,
             'view-records-section': viewRecordsSection,
             'comparison-section': comparisonSection,
             'import-export-section': importExportSection,
             'report-section': reportSectionDiv // Anadir la seccion de reporte
         };


        // Mapeo de tipos de prueba para mostrar en la tabla y analisis
        const testTypeMap = {
            speed30m: 'Velocidad 30m',
            situps30s: 'Abdominales Rectos 30s',
            obliqueSitups30s: 'Abdominales Inferiores 30s',
            longJump: 'Salto Largo',
            flexibility: 'Flexibilidad',
            ropeJumps1min: 'Saltos con soga en 1 min',
            run500m: '500 metros',
            pushups30s: 'Flexiones en 30 segundos'
        };

         // Mapeo de tipos de prueba a IDs de canvas (ahora se generaran dinamicamente)
        const chartCanvasMap = {
            height: 'chartHeight',
            speed30m: 'chartSpeed30m',
            situps30s: 'chartSitups30s',
            obliqueSitups30s: 'chartObliqueSitups30s',
            longJump: 'chartLongJump',
            flexibility: 'chartFlexibility',
            ropeJumps1min: 'chartRopeJumps1min',
            run500m: 'chartRun500m',
            pushups30s: 'chartPushups30s'
        };

         // Mapeo de nombres de propiedades a encabezados de columna en espanol para CSV
         const csvHeadersMap = {
             'id': 'ID_Registro', // Anadir ID para exportacion/importacion
             'name': 'Nombre',
             'age': 'Edad',
             'sex': 'Sexo',
             'height': 'Estatura (cm)',
             'course': 'Curso',
             'school': 'Escuela',
             'district': 'Distrito',
             'testType': 'Tipo de Prueba',
             'date': 'Fecha',
             'result': 'Resultado',
             'academicYear': 'Ciclo Lectivo'
         };


        // Envuelve toda la logica principal en window.onload para asegurar que el DOM este cargado
        window.onload = () => {

             // --- Funciones de Utilidad ---

             // Funcion para formatear una fecha a dd/mm/aaaa
             function formatDate(dateString) {
                 if (!dateString) return '-';
                 try {
                     // Crea un objeto Date a partir de la cadena (asume formato YYYY-MM-DD)
                     const [year, month, day] = dateString.split('-').map(Number);
                     // El mes en Date es 0-indexed, por eso restamos 1
                     const date = new Date(year, month - 1, day);

                     // Verifica si la fecha es valida
                     if (isNaN(date.getTime())) {
                         console.warn("Invalid date string for formatting:", dateString); // Log warning for invalid date
                         return '-'; // Retorna '-' si la fecha no es valida
                     }

                     const dayFormatted = date.getDate().toString().padStart(2, '0');
                     const monthFormatted = (date.getMonth() + 1).toString().padStart(2, '0'); // Suma 1 porque los meses son 0-indexed
                     const yearFormatted = date.getFullYear();
                     return `${dayFormatted}/${monthFormatted}/${yearFormatted}`;
                 } catch (error) {
                     console.error("Error formatting date:", error);
                     return '-'; // Retorna '-' en caso de cualquier error
                 }
             }

             // Funcion para parsear una fecha desde varios formatos a YYYY-MM-DD
             function parseDateToISO(dateString) {
                 if (!dateString) return null;

                 // Intentar parsear YYYY-MM-DD (formato interno y de input[type=date])
                 const isoMatch = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                 if (isoMatch) {
                     const date = new Date(dateString);
                      if (!isNaN(date.getTime())) return dateString; // Valid ISO date
                 }

                 // Intentar parsear DD/MM/YYYY (formato comun en espanol)
                 const dmyMatch = dateString.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                 if (dmyMatch) {
                     const day = parseInt(dmyMatch[1], 10);
                     const month = parseInt(dmyMatch[2], 10) - 1; // Meses son 0-indexed
                     const year = parseInt(dmyMatch[3], 10);
                     const date = new Date(year, month, day);

                     // Validar si la fecha parseada es correcta (evita fechas como 31/02/2023)
                     if (date.getDate() === day && date.getMonth() === month && date.getFullYear() === year) {
                         return `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                     }
                 }

                  // Intentar parsear otros formatos si es necesario, o retornar null si no se puede parsear
                 console.warn("Could not parse date string:", dateString);
                 return null; // Retorna null si no se puede parsear en los formatos esperados
             }


            // Funcion para guardar los registros en localStorage
            function saveRecords() {
                try {
                    localStorage.setItem('physicalEducationRecordsIndividualV59', JSON.stringify(allRecords));
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                    console.error("No se pudo guardar la informacion. Es posible que el almacenamiento local este lleno o deshabilitado en tu navegador.");
                }
            }

             // Funcion para obtener el ciclo lectivo a partir de una fecha en formato YYYY-MM-DD
             function getAcademicYear(dateString) {
                 if (!dateString) return '-';
                 try {
                     const date = new Date(dateString);
                     // Check if the date is valid before proceeding
                     if (isNaN(date.getTime())) {
                         console.warn("Invalid date object for academic year:", dateString);
                         return '-';
                     }
                     const year = date.getFullYear();
                     const month = date.getMonth(); // 0-indexed (0 para enero, 11 para diciembre)

                     // Asumimos que el ciclo lectivo actual comienza en marzo del ano actual
                     // y termina en febrero del siguiente ano.
                     // Si la fecha es de marzo en adelante del ano actual, es el ciclo actual.
                     // Si la fecha es de enero o febrero del ano actual, es el ciclo del ano anterior.

                     if (month >= 2) { // Marzo (indice 2) a diciembre
                         return `${year}-${year + 1}`;
                     } else { // Enero o febrero
                         return `${year - 1}-${year}`;
                     }
                 } catch (error) {
                     console.error("Error getting academic year:", error);
                     return '-';
                 }
             }


             // Funcion para limpiar los campos del formulario de agregar registro (solo campos de prueba)
             function clearAddRecordFormTestFields() {
                 testTypeSelect.value = '';
                 recordDateInput.value = '';
                 testResultInput.value = '';
             }

             // Funcion para poblar las opciones de los selectores de filtro y los nuevos multi-select con checkboxes
             function populateFilterOptions() {
                 try {
                     const names = [...new Set(allRecords.map(record => record.name).filter(name => name && name.trim() !== ''))]; // Filter out empty/null names
                     const ages = [...new Set(allRecords.map(record => record.age))].filter(age => age !== undefined && age !== null && !isNaN(age)).sort((a, b) => a - b); // Filtrar undefined/null/NaN
                     const schools = [...new Set(allRecords.map(record => record.school))].filter(school => school !== undefined && school !== null && school !== '').sort(); // Filtrar undefined/null/empty
                     const districts = [...new Set(allRecords.map(record => record.district))].filter(district => district !== undefined && district !== null && district !== '').sort(); // Filtrar undefined/null/empty
                     const courses = [...new Set(allRecords.map(record => record.course))].filter(course => course !== undefined && course !== null && course !== '').sort(); // Filtrar undefined/null/empty

                     // Poblar selectores de filtro en "Ver Alumnos"
                     populateSelect(viewFilterAgeSelect, ages, 'Todas las Edades');
                      populateSelect(viewFilterCourseSelect, courses, 'Todos los Cursos');
                      // Los selectores de escuela y distrito en "Ver Alumnos" se mantienen como select simple
                     populateSelect(viewFilterSchoolSelect, schools, 'Todas las Escuelas');
                     populateSelect(viewFilterDistrictSelect, districts, 'Todos los Distritos');


                     // Poblar selectores de filtro en "Comparativo"
                     populateSelect(filterAgeSelect, ages, 'Todas las Edades');
                     populateSelect(filterCourseSelect, courses, 'Todos los Cursos');

                      // Poblar los nuevos multi-select con checkboxes
                      populateMultiSelectCheckboxes(filterSchoolDropdown, schools, 'Todas las Escuelas');
                      populateMultiSelectCheckboxes(filterDistrictDropdown, districts, 'Todos los Distritos');

                      // Poblar selector de tipo de prueba en el formulario de edicion (si aun se usara)
                      // populateSelect(editTestTypeSelect, Object.keys(testTypeMap), '-- Seleccionar Prueba --', testTypeMap);

                 } catch (error) {
                     console.error("Error populating filter options:", error);
                 }
             }

             // Funcion auxiliar para poblar un selector (con mapeo opcional para texto)
             function populateSelect(selectElement, options, defaultText, textMap = {}) {
                 // Clear existing options, but keep the default option if it exists
                 const defaultOption = selectElement.querySelector('option[value=""]');
                 selectElement.innerHTML = ''; // Clear all options
                 if (defaultOption) {
                     selectElement.appendChild(defaultOption);
                 } else {
                     // If no default option, create one
                      const newDefaultOption = document.createElement('option');
                      newDefaultOption.value = "";
                      newDefaultOption.textContent = defaultText;
                      selectElement.appendChild(newDefaultOption);
                 }


                 options.forEach(optionValue => {
                     if (optionValue !== undefined && optionValue !== null && optionValue !== '') {
                         const option = document.createElement('option');
                         option.value = optionValue;
                         option.textContent = textMap[optionValue] || optionValue; // Usar el texto mapeado si existe
                         selectElement.appendChild(option);
                     }
                 });
             }

             // Funcion auxiliar para poblar un contenedor con checkboxes para multi-seleccion
             function populateMultiSelectCheckboxes(dropdownElement, options, defaultText) {
                 dropdownElement.innerHTML = ''; // Limpiar opciones anteriores

                 // Anadir opcion "Todas"
                 const allLabel = document.createElement('label');
                 const allCheckbox = document.createElement('input');
                 allCheckbox.type = 'checkbox';
                 allCheckbox.value = ""; // Valor vacio para "Todas"
                 allCheckbox.checked = true; // Marcar "Todas" por defecto
                 allLabel.appendChild(allCheckbox);
                 allLabel.appendChild(document.createTextNode(` ${defaultText}`));
                 dropdownElement.appendChild(allLabel);

                 // Anadir las demas opciones
                 options.forEach(optionValue => {
                      if (optionValue !== undefined && optionValue !== null && optionValue !== '') {
                           const label = document.createElement('label');
                           const checkbox = document.createElement('input');
                           checkbox.type = 'checkbox';
                           checkbox.value = optionValue;
                            checkbox.checked = true; // Marcar por defecto si "Todas" esta marcado
                           label.appendChild(checkbox);
                           label.appendChild(document.createTextNode(` ${optionValue}`));
                           dropdownElement.appendChild(label);
                      }
                 });
             }


             // Funcion para filtrar registros
             function filterRecords(records, filters) {
                 return records.filter(record => {
                     let passesFilter = true;

                     // Filtrar por Nombre (busqueda parcial e insensible a mayusculas) - Solo si se proporciona un nombre en los filtros
                     if (filters.name && record.name) {
                         if (!record.name.toLowerCase().includes(filters.name.toLowerCase())) {
                             passesFilter = false;
                         }
                     }

                     // Filtrar por Edad
                     if (filters.age && record.age !== undefined && record.age !== null) {
                         if (record.age !== parseInt(filters.age)) {
                             passesFilter = false;
                         }
                     }

                     // Filtrar por Sexo
                     if (filters.sex && record.sex) {
                         if (record.sex !== filters.sex) {
                             passesFilter = false;
                         }
                     }

                     // Filtrar por Estatura Minima
                     if (filters.minHeight !== undefined && filters.minHeight !== null && filters.minHeight !== '') {
                         // Convertir a numero solo si el filtro no esta vacio
                         const minHeightValue = parseFloat(filters.minHeight);
                         if (!isNaN(minHeightValue)) {
                             if (record.height === undefined || record.height === null || parseFloat(record.height) < minHeightValue) {
                                 passesFilter = false;
                             }
                         }
                     }


                     // Filtrar por Curso
                     if (filters.course && record.course) {
                         if (record.course !== filters.course) {
                             passesFilter = false;
                         }
                     }

                     // Filtrar por Escuela (maneja array de multiples selecciones desde checkboxes)
                     if (filters.schools && filters.schools.length > 0) {
                          // Si 'Todas las Escuelas' esta seleccionado (valor vacio), ignora el filtro de escuela
                          if (!filters.schools.includes("")) {
                               if (!record.school || !filters.schools.includes(record.school)) {
                                   passesFilter = false;
                               }
                          }
                     }

                     // Filtrar por Distrito (maneja array de multiples selecciones desde checkboxes)
                     if (filters.districts && filters.districts.length > 0) {
                          // Si 'Todos los Distritos' esta seleccionado (valor vacio), ignora el filtro de distrito
                          if (!filters.districts.includes("")) {
                               if (!record.district || !filters.districts.includes(record.district)) {
                                   passesFilter = false;
                               }
                          }
                     }


                     // Filtrar por Tipo de Prueba (solo si se proporciona en los filtros)
                     if (filters.testType && record.testType) {
                         if (record.testType !== filters.testType) {
                             passesFilter = false;
                         }
                     }


                     return passesFilter;
                 });
             }

             // Funcion para obtener filtros de la seccion "Ver Alumnos"
             function getViewFilters() {
                 return {
                     age: viewFilterAgeSelect.value,
                     sex: viewFilterSexSelect.value,
                     minHeight: viewFilterHeightInput.value.trim(),
                     course: viewFilterCourseSelect.value,
                     school: viewFilterSchoolSelect.value,
                     district: viewFilterDistrictSelect.value
                 };
             }

              // Funcion para obtener filtros de la seccion "Comparativo" (ahora maneja multiples selecciones de checkboxes)
              function getComparisonFilters() {
                   // Obtener valores de los checkboxes seleccionados para escuelas
                   const selectedSchools = Array.from(filterSchoolDropdown.querySelectorAll('input[type="checkbox"]:checked:not([value=""])')).map(checkbox => checkbox.value);
                   // Obtener valores de los checkboxes seleccionados para distritos
                   const selectedDistricts = Array.from(filterDistrictDropdown.querySelectorAll('input[type="checkbox"]:checked:not([value=""])')).map(checkbox => checkbox.value);

                  // Verificar si la opcion "Todas" esta marcada para escuelas y distritos
                  const allSchoolsChecked = filterSchoolDropdown.querySelector('input[value=""]').checked;
                  const allDistrictsChecked = filterDistrictDropdown.querySelector('input[value=""]').checked;


                  return {
                      age: filterAgeSelect.value,
                      sex: filterSexSelect.value,
                      course: filterCourseSelect.value,
                      schools: allSchoolsChecked ? [] : selectedSchools, // Usar array vacio si "Todas" esta marcado
                      districts: allDistrictsChecked ? [] : selectedDistricts, // Usar array vacio si "Todos" esta marcado
                      testType: filterTestTypeSelect.value // Filtro de prueba especifico para comparativo
                  };
              }


             // Funcion para filtrar y mostrar alumnos en la seccion "Ver Alumnos"
             function filterAndDisplayStudents() {
                 const filters = getViewFilters();
                 // Primero, filtrar todos los registros por los filtros avanzados (sin el nombre de busqueda)
                 const filteredRecordsPool = allRecords.filter(record => {
                      let passesFilters = true;
                      if (filters.age && record.age !== undefined && record.age !== null && record.age !== parseInt(filters.age)) passesFilters = false;
                      if (filters.sex && record.sex && record.sex !== filters.sex) passesFilters = false;
                       if (filters.minHeight !== undefined && filters.minHeight !== null && filters.minHeight !== '') {
                           const minHeightValue = parseFloat(filters.minHeight);
                           if (!isNaN(minHeightValue) && (record.height === undefined || record.height === null || parseFloat(record.height) < minHeightValue)) {
                               passesFilters = false;
                           }
                       }
                      if (filters.course && record.course && record.course !== filters.course) passesFilters = false;
                      if (filters.school && record.school && record.school !== filters.school) passesFilters = false;
                      if (filters.district && record.district && record.district !== filters.district) passesFilters = false;
                      return passesFilters;
                 });


                 // Obtener alumnos unicos de este pool filtrado, identificados por Nombre, Curso, Escuela y Distrito
                 const uniqueStudentIdentities = {};
                 filteredRecordsPool.forEach(record => {
                      const identityKey = `${record.name}|${record.course}|${record.school}|${record.district}`; // Clave unica
                      if (record.name && !uniqueStudentIdentities[identityKey]) {
                           // Usar los datos del registro mas reciente para los datos generales del alumno en la lista filtrada
                           const studentRecords = allRecords.filter(r =>
                               r.name === record.name &&
                               r.course === record.course &&
                               r.school === r.school && // Use r.school here to match the record's school
                               r.district === r.district // Use r.district here to match the record's district
                           );
                           studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                           const mostRecentRecord = studentRecords.length > 0 ? studentRecords[0] : record; // Fallback to current record if no dated records

                           uniqueStudentIdentities[identityKey] = {
                               name: mostRecentRecord.name,
                               age: mostRecentRecord.age,
                               sex: mostRecentRecord.sex,
                               height: mostRecentRecord.height,
                               course: mostRecentRecord.course,
                               school: mostRecentRecord.school,
                               district: mostRecentRecord.district
                           };
                      }
                 });

                 // Convertir a un array de objetos alumno y ordenar por nombre
                 filteredStudentList = Object.values(uniqueStudentIdentities).sort((a, b) => a.name.localeCompare(b.name));

                 // Limpiar selectores y resultados de busqueda
                 selectStudentSelect.innerHTML = '<option value="">-- Seleccionar Alumno --</option>';
                 searchResultsUl.innerHTML = '';

                 // Poblar el selector y la lista de resultados de busqueda con la identidad combinada
                 filteredStudentList.forEach(student => {
                     const displayString = `${student.name} (${student.course || '-'}, ${student.school || '-'}, ${student.district || '-'})`;
                     const identityJson = JSON.stringify({
                         name: student.name,
                         course: student.course,
                         school: student.school,
                         district: student.district
                     });

                     // Agregar al selector
                     const option = document.createElement('option');
                     option.value = identityJson; // Usar JSON string como valor
                     option.textContent = displayString;
                     selectStudentSelect.appendChild(option);

                     // Agregar a la lista de resultados de busqueda (inicialmente oculta)
                     const li = document.createElement('li');
                     li.textContent = displayString;
                     li.dataset.studentIdentity = identityJson; // Almacenar JSON string en data attribute
                     searchResultsUl.appendChild(li);
                 });


                 // Ahora, aplicar el filtro de busqueda a la lista filtrada para mostrar en los resultados de busqueda
                 const searchTerm = searchInput.value.trim().toLowerCase();
                 const searchResults = filteredStudentList.filter(student => {
                      const displayString = `${student.name} (${student.course || '-'}, ${student.school || '-'}, ${student.district || '-'})`.toLowerCase();
                      return displayString.includes(searchTerm);
                 });

                 displaySearchResults(searchResults); // Mostrar resultados de busqueda
             }

             // Funcion para mostrar los resultados de busqueda (en la lista debajo del input de busqueda)
             function displaySearchResults(results) {
                 searchResultsUl.innerHTML = ''; // Limpiar resultados anteriores

                 const searchTerm = searchInput.value.trim();

                 // Ocultar la lista si no hay termino de busqueda
                 if (searchTerm === '') {
                      searchResultsUl.classList.remove('visible');
                      // No ocultar studentRecordsDiv aqui, ya que podria estar mostrando un alumno seleccionado del selector
                      return;
                 }

                 if (results.length === 0) {
                     const li = document.createElement('li');
                     li.textContent = 'No se encontraron alumnos.';
                     li.classList.add('text-gray-500', 'italic');
                     searchResultsUl.appendChild(li);
                     // No ocultar studentRecordsDiv aqui
                     searchResultsUl.classList.add('visible'); // Mostrar lista aunque este vacia si hay termino de busqueda
                     return;
                 }

                 // Poblar la lista de resultados de busqueda
                 results.forEach(student => {
                      const displayString = `${student.name} (${student.course || '-'}, ${student.school || '-'}, ${student.district || '-'})`;
                      const identityJson = JSON.stringify({
                           name: student.name,
                           course: student.course,
                           school: student.school,
                           district: student.district
                      });
                     const li = document.createElement('li');
                     li.textContent = displayString;
                     li.dataset.studentIdentity = identityJson; // Almacenar JSON string en data attribute
                     searchResultsUl.appendChild(li);
                 });

                 // Mostrar la lista de resultados
                 searchResultsUl.classList.add('visible');
             }


             // Funcion para mostrar los registros de un alumno seleccionado (por identidad)
             function displayStudentRecords(studentIdentity) {
                 const studentRecords = allRecords.filter(record =>
                     record.name === studentIdentity.name &&
                     record.course === studentIdentity.course &&
                     record.school === studentIdentity.school &&
                     record.district === studentIdentity.district
                 );

                 if (studentRecords.length === 0) {
                     studentRecordsDiv.classList.add('hidden');
                     // Limpiar los campos de datos del alumno si no hay registros
                     selectedStudentNameDisplay.textContent = '';
                     studentAgeDisplaySpan.textContent = '-';
                     studentSexDisplaySpan.textContent = '-';
                     studentHeightDisplaySpan.textContent = '-';
                     studentCourseDisplaySpan.textContent = '-';
                     studentSchoolDisplaySpan.textContent = '-';
                     studentDistrictDisplaySpan.textContent = '-';
                     recordsTableBody.innerHTML = '';
                      // Limpiar el data attribute de identidad
                      studentRecordsDivData.dataset.currentStudentIdentity = '';
                      // Limpiar el analisis
                      analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                       generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                       // Limpiar iconos de distincion Top 1 en el nombre
                       const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                       if (existingTop1Icons) existingTop1Icons.remove();


                     return;
                 }

                 // Mostrar la seccion de registros
                 studentRecordsDiv.classList.remove('hidden');
                  // Guardar la identidad del alumno seleccionado en un data attribute
                 studentRecordsDivData.dataset.currentStudentIdentity = JSON.stringify(studentIdentity);


                 // Mostrar datos generales del alumno (usamos los datos del registro mas reciente)
                  const studentData = studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date))[0] || {};

                 selectedStudentNameDisplay.textContent = `${studentData.name || '-'} (${studentData.course || '-'}, ${studentData.school || '-'}, ${studentData.district || '-'})`;
                 studentAgeDisplaySpan.textContent = studentData.age || '-';
                 studentSexDisplaySpan.textContent = studentData.sex ? (studentData.sex.charAt(0).toUpperCase() + studentData.sex.slice(1)) : '-'; // Capitalizar
                 studentHeightDisplaySpan.textContent = studentData.height || '-';
                 studentCourseDisplaySpan.textContent = studentData.course || '-';
                 studentSchoolDisplaySpan.textContent = studentData.school || '-';
                 studentDistrictDisplaySpan.textContent = studentData.district || '-';

                 // Ocultar el modo edicion y mostrar el modo visualizacion
                 studentDataDisplayDiv.classList.remove('hidden');
                 studentDataEditDiv.classList.add('hidden');
                 studentAnalysisDiv.classList.remove('hidden'); // Asegurar que el analisis este visible


                 // Generar y mostrar el analisis de fortalezas y debilidades y ranking
                 generateStudentAnalysis(studentIdentity);


                 // Mostrar registros de pruebas en la tabla
                 recordsTableBody.innerHTML = ''; // Limpiar tabla anterior

                 // Ordenar registros por fecha (mas reciente primero)
                 studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

                 studentRecords.forEach(record => {
                     const row = document.createElement('tr');
                     row.dataset.recordId = record.id; // Anadir data attribute con el ID del registro

                     // Usar template strings para construir el HTML de la fila con los botones originales
                     row.innerHTML = `
                         <td>${formatDate(record.date)}</td>
                         <td>${testTypeMap[record.testType] || record.testType || '-'}</td>
                         <td>${record.result || '-'}</td>
                         <td>${record.academicYear || '-'}</td> <td>
                             <button class="edit-record-btn inline-action-btn" data-id="${record.id}" title="Editar Registro"><i class="fas fa-edit"></i> Editar</button>
                             <button class="delete-record-btn inline-action-btn" data-id="${record.id}" title="Eliminar Registro"><i class="fas fa-trash-alt"></i> Eliminar</button>
                         </td>
                     `;
                     recordsTableBody.appendChild(row); // Use recordsTableBody here
                 });
                 // No necesitamos attachRecordButtonListeners aqui si usamos delegacion en el tbody
             }

             // Funcion para adjuntar event listeners a los botones de registro individual (usando delegacion)
             function attachRecordButtonListeners() {
                 // Event delegation en la tabla de registros del alumno
                 recordsTableBody.addEventListener('click', handleTableButtonClick);

                 // Event delegation en el contenedor de resultados individuales de la ficha del alumno
                 individualResultsContainer.addEventListener('click', handleTableButtonClick);
             }

             // Manejador de clic delegado para los botones de las tablas de registros
             function handleTableButtonClick(event) {
                 const target = event.target;
                 const button = target.closest('button'); // Encuentra el boton mas cercano

                 if (!button) return; // No es un clic en un boton

                 const row = button.closest('tr'); // Encuentra la fila mas cercana
                 if (!row) return; // No es un clic dentro de una fila de tabla

                 const recordId = row.dataset.recordId; // Obtener el ID del registro desde la fila

                 if (button.classList.contains('edit-record-btn')) {
                     // Accion de Editar
                     handleEditRecordClick(row, recordId);
                 } else if (button.classList.contains('delete-record-btn')) {
                     // Accion de Eliminar
                     handleDeleteRecordClick(recordId);
                 } else if (button.classList.contains('save-inline-edit-btn')) {
                     // Accion de Guardar (edicion inline)
                     handleSaveInlineEdit(row, recordId);
                 } else if (button.classList.contains('cancel-inline-edit-btn')) {
                     // Accion de Cancelar (edicion inline)
                     handleCancelInlineEdit(row, recordId);
                 }
             }


             // Manejador para el clic en el boton de editar registro individual (ahora inline)
             function handleEditRecordClick(row, recordId) {
                 // Si ya hay una fila editandose, cancelarla primero
                 if (editingRow && editingId !== recordId) { // Check if a different row is being edited
                     handleCancelInlineEdit(editingRow, editingId);
                 }

                 const record = allRecords.find(r => r.id === recordId);

                 if (!record) {
                     console.error('Registro no encontrado.');
                     return;
                 }

                 editingRow = row; // Establecer la fila que se esta editando
                 editingId = recordId; // Store the ID of the record being edited

                 const cells = row.querySelectorAll('td');
                 const dateCell = cells[0];
                 const testTypeCell = cells[1];
                 const resultCell = cells[2];
                 const actionsCell = cells[4]; // La celda de acciones es la quinta (indice 4)

                 // Guardar el HTML original de las celdas para poder restaurar al cancelar
                 row.dataset.originalDateHtml = dateCell.innerHTML;
                 row.dataset.originalTestTypeHtml = testTypeCell.innerHTML;
                 row.dataset.originalResultHtml = resultCell.innerHTML;
                 row.dataset.originalActionsHtml = actionsCell.innerHTML;


                 // Reemplazar el contenido de las celdas con inputs/selects
                 dateCell.innerHTML = `<input type="date" value="${record.date || ''}" class="w-full p-1 border rounded text-sm">`;

                 // Crear selector para Tipo de Prueba
                 const testTypeSelectInput = document.createElement('select');
                 testTypeSelectInput.classList.add('w-full', 'p-1', 'border', 'rounded', 'text-sm');
                 // Anadir opcion por defecto
                 let optionsHtml = `<option value="">-- Seleccionar Prueba --</option>`;
                 // Anadir opciones del testTypeMap
                 for (const key in testTypeMap) {
                     optionsHtml += `<option value="${key}" ${record.testType === key ? 'selected' : ''}>${testTypeMap[key]}</option>`;
                 }
                 testTypeSelectInput.innerHTML = optionsHtml;
                 testTypeCell.innerHTML = ''; // Limpiar celda
                 testTypeCell.appendChild(testTypeSelectInput); // Anadir el selector


                 resultCell.innerHTML = `<input type="number" value="${record.result || ''}" step="0.01" class="w-full p-1 border rounded text-sm">`;

                 // Reemplazar los botones de accion con Guardar y Cancelar
                 actionsCell.innerHTML = `
                     <button class="save-inline-edit-btn inline-action-btn" title="Guardar Cambios"><i class="fas fa-save"></i> Guardar</button>
                     <button class="cancel-inline-edit-btn inline-action-btn" title="Cancelar Edicion"><i class="fas fa-times"></i> Cancelar</button>
                 `;
             }


             // Manejador para guardar la edicion inline
             function handleSaveInlineEdit(row, recordId) {
                 const recordIndex = allRecords.findIndex(r => r.id === recordId);

                 if (recordIndex === -1) {
                     console.error('Error al guardar: Registro no encontrado.');
                     // Intentar cancelar la edicion de la fila actual
                     handleCancelInlineEdit(row, recordId);
                     return;
                 }

                 const cells = row.querySelectorAll('td');
                 const newDate = cells[0].querySelector('input').value;
                 const newTestType = cells[1].querySelector('select').value;
                 const newResult = parseFloat(cells[2].querySelector('input').value);

                 // Validar los nuevos valores
                 if (!newDate || !newTestType || isNaN(newResult)) {
                     console.error('Por favor, completa todos los campos (Fecha, Tipo de Prueba, Resultado) para guardar.');
                     return;
                 }

                 // Actualizar el registro en el array
                 allRecords[recordIndex].date = newDate;
                 allRecords[recordIndex].testType = newTestType;
                 allRecords[recordIndex].result = newResult;
                 allRecords[recordIndex].academicYear = getAcademicYear(newDate); // Recalcular ciclo lectivo

                 // Guardar en localStorage
                 saveRecords();

                 // Restaurar la fila a modo visualizacion
                 restoreRowDisplay(row, allRecords[recordIndex]);

                 // Limpiar la referencia a la fila en edicion
                 editingRow = null;
                 editingId = null; // Clear the ID of the record being edited

                 console.log('Registro actualizado correctamente.');

                 // Si estamos en la seccion de reporte, regenerar la ficha para actualizar graficos
                 if (currentSectionId === 'report-section') {
                      const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                      if (currentStudentIdentityJson) {
                           const currentStudentIdentity = JSON.parse(currentStudentIdentityJson);
                           generateReport(currentStudentIdentity);
                      }
                 }
                  // Si estamos en la seccion de ver registros, actualizar la tabla (ya se hizo en restoreRowDisplay)
                  // y actualizar la lista de alumnos si cambiaron datos que afectan la identidad (aunque no deberian cambiar aqui)
                  // Mejor, simplemente refrescar la vista del alumno actual y el analisis
                  if (currentSectionId === 'view-records-section') {
                       const currentStudentIdentityJson = selectStudentSelect.value; // Obtener del selector
                       if (currentStudentIdentityJson) {
                            const currentStudentIdentity = JSON.parse(currentStudentIdentityJson);
                            displayStudentRecords(currentStudentIdentity); // Volver a mostrar los registros para refrescar
                       }
                  }
             }

             // Manejador para cancelar la edicion inline
             function handleCancelInlineEdit(row, recordId) {
                 // Restaurar el contenido original de las celdas
                 const cells = row.querySelectorAll('td');
                 cells[0].innerHTML = row.dataset.originalDateHtml;
                 cells[1].innerHTML = row.dataset.originalTestTypeHtml;
                 cells[2].innerHTML = row.dataset.originalResultHtml;
                 cells[4].innerHTML = row.dataset.originalActionsHtml; // Restaurar los botones originales

                 // Limpiar los data attributes de respaldo
                 delete row.dataset.originalDateHtml;
                 delete row.dataset.originalTestTypeHtml;
                 delete row.dataset.originalResultHtml;
                 delete row.dataset.originalActionsHtml;

                 // Limpiar la referencia a la fila en edicion
                 editingRow = null;
                 editingId = null; // Clear the ID of the record being edited
             }

             // Funcion para restaurar la visualizacion de la fila despues de guardar
             function restoreRowDisplay(row, updatedRecord) {
                  const cells = row.querySelectorAll('td');
                  cells[0].textContent = formatDate(updatedRecord.date);
                  cells[1].textContent = testTypeMap[updatedRecord.testType] || updatedRecord.testType || '-';
                  cells[2].textContent = updatedRecord.result || '-';
                  cells[3].textContent = updatedRecord.academicYear || '-'; // Actualizar ciclo lectivo

                  // Restaurar los botones originales
                  cells[4].innerHTML = `
                      <button class="edit-record-btn inline-action-btn" data-id="${updatedRecord.id}" title="Editar Registro"><i class="fas fa-edit"></i> Editar</button>
                      <button class="delete-record-btn inline-action-btn" data-id="${updatedRecord.id}" title="Eliminar Registro"><i class="fas fa-trash-alt"></i> Eliminar</button>
                  `;

                  // Limpiar los data attributes de respaldo
                  delete row.dataset.originalDateHtml;
                  delete row.dataset.originalTestTypeHtml;
                  delete row.dataset.originalResultHtml;
                  delete row.dataset.originalActionsHtml;
             }


             // Manejador para el clic en el boton de eliminar registro individual
             function handleDeleteRecordClick(recordId) {
                 const recordIndex = allRecords.findIndex(r => r.id === recordId);

                 if (recordIndex === -1) {
                     console.error('Registro no encontrado.');
                      // Intentar refrescar la vista si el registro no se encuentra
                      const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                      if (currentStudentIdentityJson) {
                           const currentStudentIdentity = JSON.parse(currentStudentIdentityJson);
                           displayStudentRecords(currentStudentIdentity);
                      }
                     return;
                 }

                 // Reemplazar confirm con console.log y accion directa
                 console.log('Confirmacion de eliminacion de registro: ¿Estas seguro de que deseas eliminar este registro?');
                 // Eliminar el registro directamente
                 // Obtener la identidad del alumno antes de eliminar el registro
                 const studentIdentity = {
                      name: allRecords[recordIndex].name,
                      course: allRecords[recordIndex].course,
                      school: allRecords[recordIndex].school,
                      district: allRecords[recordIndex].district
                 };


                 // Eliminar el registro del array
                 allRecords.splice(recordIndex, 1);

                 // Guardar en localStorage
                 saveRecords();

                 // Si estamos en la seccion de ver registros, actualizar esa tabla
                 if (currentSectionId === 'view-records-section') {
                     displayStudentRecords(studentIdentity); // Volver a mostrar los registros para refrescar
                 } else if (currentSectionId === 'report-section') {
                      // Si estamos en la seccion de reporte, regenerar la ficha
                      generateReport(studentIdentity);
                 }


                 console.log('Registro eliminado correctamente.');

                 // Si no quedan registros para esta identidad de alumno, ocultar la seccion de registros
                 const remainingRecordsForIdentity = allRecords.filter(record =>
                     !(record.name === studentIdentity.name &&
                       record.course === studentIdentity.course &&
                       record.school === studentIdentity.school &&
                       record.district === studentIdentity.district)
                 );

                 if (remainingRecordsForIdentity.length === 0) {
                     studentRecordsDiv.classList.add('hidden');
                     selectStudentSelect.value = ""; // Deseleccionar el alumno
                     populateFilterOptions(); // Actualizar filtros y datalist
                     filterAndDisplayStudents(); // Actualizar lista de alumnos filtrados
                      // Limpiar el data attribute de identidad
                      studentRecordsDivData.dataset.currentStudentIdentity = '';
                       // Limpiar el analisis
                       analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                        generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                        // Limpiar iconos de distincion Top 1 en el nombre
                        const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                        if (existingTop1Icons) existingTop1Icons.remove();

                 } else {
                      // Si quedan registros, solo actualizar la lista de alumnos filtrados si es necesario (si la eliminacion afecto los filtros)
                      populateFilterOptions();
                      filterAndDisplayStudents();
                       // Regenerar el analisis para el alumno actual
                       generateStudentAnalysis(studentIdentity);
                 }
             }


             // Manejador para el clic en el boton de editar datos del alumno
             function handleEditStudentDataClick() {
                  const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                  if (!currentStudentIdentityJson) {
                       console.error('No se ha seleccionado un alumno para editar.');
                       return;
                  }
                  const studentIdentity = JSON.parse(currentStudentIdentityJson);

                 const studentRecords = allRecords.filter(record =>
                     record.name === studentIdentity.name &&
                     record.course === studentIdentity.course &&
                     record.school === studentIdentity.school &&
                     record.district === studentIdentity.district
                 );

                 if (studentRecords.length === 0) {
                     console.error('No se encontraron datos para editar de este alumno.');
                     return;
                 }

                 // Usamos los datos del registro mas reciente para prellenar los campos de edicion
                  const studentData = studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date))[0] || {};

                 // Llenar los campos del formulario de edicion
                 studentNameEditInput.value = studentData.name || '';
                 studentAgeEditInput.value = studentData.age || '';
                 studentHeightEditInput.value = studentData.height || '';
                 studentCourseEditInput.value = studentData.course || '';

                  // Seleccionar la opcion correcta en los selectores
                 setSelectValue(studentSexEditSelect, studentData.sex);
                 setSelectValue(studentSchoolEditSelect, studentData.school);
                 setSelectValue(studentDistrictEditSelect, studentData.district);


                 // Ocultar el modo visualizacion y mostrar el modo edicion
                 studentDataDisplayDiv.classList.add('hidden');
                 studentAnalysisDiv.classList.add('hidden'); // Ocultar analisis tambien
                 studentDataEditDiv.classList.remove('hidden');
             }

             // Funcion auxiliar para establecer el valor de un selector
             function setSelectValue(selectElement, value) {
                 const option = selectElement.querySelector(`option[value="${value}"]`);
                 if (option) {
                     selectElement.value = value;
                 } else {
                     selectElement.value = ""; // Seleccionar opcion por defecto si el valor no existe
                 }
             }


             // Manejador para el clic en el boton de guardar datos del alumno
             function handleSaveStudentDataClick() {
                 const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                 if (!currentStudentIdentityJson) {
                      console.error('Error: No se ha seleccionado un alumno para guardar.');
                      return;
                 }
                 const originalStudentIdentity = JSON.parse(currentStudentIdentityJson);


                 // Obtener los nuevos valores del formulario de edicion
                 const newName = studentNameEditInput.value.trim();
                 const newAge = parseInt(studentAgeEditInput.value);
                 const newSex = studentSexEditSelect.value;
                 const newHeight = parseFloat(studentHeightEditInput.value);
                 const newCourse = studentCourseEditInput.value.trim();
                 const newSchool = studentSchoolEditSelect.value;
                 const newDistrict = studentDistrictEditSelect.value;

                 // Validar los campos obligatorios (Nombre, Edad, Sexo, Estatura, Curso, Escuela, Distrito)
                 if (!newName || isNaN(newAge) || !newSex || isNaN(newHeight) || !newCourse || !newSchool || !newDistrict) {
                     console.error('Por favor, completa todos los campos obligatorios (Nombre, Edad, Sexo, Estatura, Curso, Escuela, Distrito).');
                     return;
                 }

                 // Actualizar solo los registros que coinciden con la identidad original
                 allRecords.forEach(record => {
                     if (record.name === originalStudentIdentity.name &&
                         record.course === originalStudentIdentity.course &&
                         record.school === originalStudentIdentity.school &&
                         record.district === originalStudentIdentity.district) {

                         record.name = newName;
                         record.age = newAge;
                         record.sex = newSex;
                         record.height = newHeight;
                         record.course = newCourse;
                         record.school = newSchool;
                         record.district = newDistrict;
                         // El ciclo lectivo se mantiene asociado a la fecha del registro individual
                     }
                 });

                 // Guardar en localStorage
                 saveRecords();

                 // Crear la nueva identidad del alumno
                 const newStudentIdentity = {
                      name: newName,
                      course: newCourse,
                      school: newSchool,
                      district: newDistrict
                 };

                 // Actualizar el selector de alumnos y los resultados de busqueda
                 populateFilterOptions();
                 filterAndDisplayStudents();

                 // Seleccionar el alumno con la nueva identidad en el selector
                  const newIdentityJson = JSON.stringify(newStudentIdentity);
                 selectStudentSelect.value = newIdentityJson;

                 // Mostrar los registros actualizados del alumno (usando la nueva identidad)
                 displayStudentRecords(newStudentIdentity);

                 console.log('Datos del alumno actualizados correctamente.');
             }

             // Manejador para el clic en el boton de cancelar edicion de datos del alumno
             function handleCancelStudentDataClick() {
                 // Ocultar el modo edicion y mostrar el modo visualizacion y analisis
                 studentDataEditDiv.classList.add('hidden');
                 studentDataDisplayDiv.classList.remove('hidden');
                 studentAnalysisDiv.classList.remove('hidden');
                 // Los datos mostrados en el modo visualizacion ya deberian ser los correctos
             }


             // Manejador para el clic en el boton de eliminar alumno completo
             function handleDeleteStudentClick() {
                 const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                 if (!currentStudentIdentityJson) {
                     console.error('Por favor, selecciona un alumno para eliminar.');
                     return;
                 }
                 const studentIdentity = JSON.parse(currentStudentIdentityJson);
                 const displayString = `${studentIdentity.name} (${studentIdentity.course || '-'}, ${studentIdentity.school || '-'}, ${studentIdentity.district || '-'})`;

                 // Reemplazar confirm con console.log y accion directa
                 console.log(`Confirmacion de eliminacion de alumno: ¿Estas seguro de que deseas eliminar todos los registros de ${displayString}? Esta accion no se puede deshacer.`);
                 // Eliminar registros directamente
                 // Filtrar para mantener solo los registros que NO pertenecen a esta identidad de alumno
                 allRecords = allRecords.filter(record =>
                     !(record.name === studentIdentity.name &&
                       record.course === studentIdentity.course &&
                       record.school === studentIdentity.school &&
                       record.district === studentIdentity.district)
                 );

                 // Guardar en localStorage
                 saveRecords();

                 // Limpiar la interfaz de registros del alumno
                 studentRecordsDiv.classList.add('hidden');
                 selectedStudentNameDisplay.textContent = '';
                 recordsTableBody.innerHTML = '';
                  // Limpiar el data attribute de identidad
                  studentRecordsDivData.dataset.currentStudentIdentity = '';
                   // Limpiar el analisis
                   analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                    generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                    // Limpiar iconos de distincion Top 1 en el nombre
                    const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                    if (existingTop1Icons) existingTop1Icons.remove();


                 // Actualizar el selector de alumnos y los resultados de busqueda
                 populateFilterOptions();
                 filterAndDisplayStudents();

                 console.log(`Todos los registros de ${displayString} han sido eliminados.`);
             }


             // Funcion para generar la ficha del alumno (por identidad)
             function generateReport(studentIdentity) {
                 const studentRecords = allRecords.filter(record =>
                     record.name === studentIdentity.name &&
                     record.course === studentIdentity.course &&
                     record.school === studentIdentity.school &&
                     record.district === studentIdentity.district
                 );

                 if (studentRecords.length === 0) {
                     console.error('No hay registros para generar la ficha de este alumno.');
                     return;
                 }

                 // Mostrar la seccion de reporte y ocultar las otras
                 navigateToSection('report-section');


                 // Mostrar datos generales del alumno en el reporte (usamos los datos del registro mas reciente)
                 const studentData = studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date))[0] || {};

                 reportStudentNameSpan.textContent = `${studentData.name || '-'} (${studentData.course || '-'}, ${studentData.school || '-'}, ${studentData.district || '-'})`;
                 reportDateSpan.textContent = formatDate(new Date().toISOString().split('T')[0]); // Fecha actual
                 reportStudentAgeSpan.textContent = studentData.age || '-';
                 reportStudentSexSpan.textContent = studentData.sex ? (studentData.sex.charAt(0).toUpperCase() + studentData.sex.slice(1)) : '-';
                 reportStudentHeightSpan.textContent = studentData.height || '-';
                 reportStudentCourseSpan.textContent = studentData.course || '-';
                 reportStudentSchoolSpan.textContent = studentData.school || '-';
                 reportStudentDistrictSpan.textContent = studentData.district || '-';
                 // El ciclo lectivo en el reporte deberia basarse en la fecha del registro,
                 // pero para el dato general usamos el del primer registro.
                 reportAcademicYearSpan.textContent = studentData.academicYear || '-';


                 // Limpiar contenedores anteriores
                 individualResultsContainer.innerHTML = '';
                 evolutionAnalysisDiv.innerHTML = '';

                  // Destruir todas las instancias de graficos anteriores
                  for (const chartId in chartInstances) {
                      if (chartInstances[chartId]) {
                          chartInstances[chartId].destroy();
                          delete chartInstances[chartId]; // Eliminar la referencia
                      }
                  }


                 // Agrupar registros por tipo de prueba (incluyendo estatura)
                 const groupedRecords = studentRecords.reduce((acc, record) => {
                     const key = record.testType || 'height'; // Usar 'height' como clave para la estatura
                     if (!acc[key]) {
                         acc[key] = [];
                     }
                     acc[key].push(record);
                     return acc;
                 }, {});

                 // Procesar cada grupo (prueba o estatura)
                 for (const testType in groupedRecords) {
                     const records = groupedRecords[testType];

                     // Ordenar registros por fecha (mas antiguo primero para el grafico)
                     records.sort((a, b) => new Date(a.date) - new Date(b.date));

                     const sectionItem = document.createElement('div');
                     sectionItem.classList.add('report-section-item');

                     // Titulo de la seccion (Prueba o Estatura)
                     const sectionTitle = document.createElement('h3');
                     sectionTitle.classList.add('text-lg', 'font-semibold', 'mb-2');
                     sectionTitle.textContent = testType === 'height' ? 'Estatura' : (testTypeMap[testType] || testType); // Titulo para Estatura o Prueba
                     sectionItem.appendChild(sectionTitle);

                     // Contenedor para la tabla y el grafico (flexbox)
                     const reportContentRow = document.createElement('div');
                     reportContentRow.classList.add('report-content-row'); // Clase para el flexbox


                     // Contenedor para la tabla (izquierda)
                     const tableContainer = document.createElement('div');
                     tableContainer.classList.add('w-full', 'md:w-1/2'); // Ocupa todo el ancho en movil, mitad en desktop

                     // Tabla de historial de resultados
                     const tableTitle = document.createElement('h4');
                     tableTitle.classList.add('text-md', 'font-semibold', 'mb-1');
                     tableTitle.textContent = 'Historial de Resultados';
                     tableContainer.appendChild(tableTitle);

                     const table = document.createElement('table');
                     table.classList.add('min-w-full', 'divide-y', 'divide-gray-200');
                     const thead = document.createElement('thead');
                     const tbody = document.createElement('tbody');
                     // Anadir data attribute con la identidad del alumno para delegacion de eventos
                     tbody.dataset.studentIdentity = JSON.stringify(studentIdentity);


                     thead.innerHTML = `
                         <tr>
                             <th>Fecha</th>
                             <th>Resultado</th>
                             <th>Ciclo Lectivo</th>
                             <th>Acciones</th> </tr>
                     `;

                     records.forEach(record => {
                         const row = document.createElement('tr');
                         row.dataset.recordId = record.id; // Anadir data attribute con el ID del registro
                         row.dataset.originalTestType = record.testType; // Guardar tipo de prueba original para el selector

                         row.innerHTML = `
                             <td>${formatDate(record.date)}</td>
                             <td>${record.result || '-'}</td>
                             <td>${record.academicYear || '-'}</td> <td>
                                 <button class="edit-record-btn inline-action-btn" data-id="${record.id}" title="Editar Registro"><i class="fas fa-edit"></i> Editar</button>
                                 <button class="delete-record-btn inline-action-btn" data-id="${record.id}" title="Eliminar Registro"><i class="fas fa-trash-alt"></i> Eliminar</button>
                             </td>
                         `;
                         tbody.appendChild(row);
                     });

                     table.appendChild(thead);
                     table.appendChild(tbody);
                     tableContainer.appendChild(table);
                     reportContentRow.appendChild(tableContainer); // Anadir contenedor de tabla a la fila


                     // Contenedor para el grafico (derecha)
                     const chartWrapper = document.createElement('div');
                     chartWrapper.classList.add('w-full', 'md:w-1/2'); // Ocupa todo el ancho en movil, mitad en desktop

                     // Grafico de evolucion (solo si hay al menos 2 registros con resultados numericos validos)
                     const recordsWithValidResults = records.filter(record => record.result !== undefined && record.result !== null && !isNaN(record.result));

                     if (recordsWithValidResults.length >= 2) {
                         const chartContainer = document.createElement('div');
                         chartContainer.classList.add('chart-container'); // Clase para estilos del contenedor
                         const canvas = document.createElement('canvas');
                         // Usar un ID unico para cada canvas basado en el tipo de prueba
                         const canvasId = chartCanvasMap[testType] || `chart-${testType}`;
                         canvas.id = canvasId;
                         chartContainer.appendChild(canvas);
                         chartWrapper.appendChild(chartContainer); // Anadir contenedor de grafico al wrapper


                         // Crear nuevo grafico
                         const ctx = canvas.getContext('2d');
                         try { // Add try-catch around chart creation
                             chartInstances[canvasId] = new Chart(ctx, {
                                 type: 'line',
                                 data: {
                                     labels: recordsWithValidResults.map(record => formatDate(record.date)), // Fechas en el eje X
                                     datasets: [{
                                         label: testType === 'height' ? 'Estatura (cm)' : (testTypeMap[testType] || testType),
                                         data: recordsWithValidResults.map(record => record.result), // Resultados en el eje Y
                                         borderColor: testType === 'height' ? '#3b82f6' : '#2ecc71', // Color diferente para estatura
                                         backgroundColor: testType === 'height' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(46, 204, 113, 0.2)',
                                         tension: 0.1, // Curva suave
                                         fill: true
                                     }]
                                 },
                                 options: {
                                     responsive: true,
                                     maintainAspectRatio: false, // Permitir que el grafico no mantenga el aspect ratio por defecto
                                     scales: {
                                         x: {
                                             title: {
                                                 display: true,
                                                 text: 'Fecha'
                                             }
                                         },
                                         y: {
                                             title: {
                                                 display: true,
                                                  // Determinar texto del titulo del eje Y
                                                  text: testType === 'height' ? 'Estatura (cm)' : (testTypeMap[testType] || testType),
                                             },
                                             // Invertir eje Y para que siempre sea de menor a mayor
                                             reverse: false,
                                             beginAtZero: testType !== 'height' && testType !== 'flexibility' // Empezar en cero para pruebas de repeticiones/tiempo, no para estatura o flexibilidad (que puede tener valores negativos)
                                         }
                                     }
                                 }
                             });
                         } catch (chartError) {
                             console.error("Error creating chart for", testType, ":", chartError);
                             // Display an error message in the chart container
                             chartContainer.innerHTML = `<p class="text-center text-red-500">Error al generar el grafico de ${testTypeMap[testType] || testType}.</p>`;
                         }

                     } else {
                          // Si no hay suficientes registros para el grafico, mostrar un mensaje
                          const messageContainer = document.createElement('div');
                          messageContainer.classList.add('chart-container', 'flex', 'items-center', 'justify-center', 'text-gray-500', 'italic');
                          messageContainer.textContent = `Se necesitan al menos 2 registros con resultados validos para mostrar el grafico de evolucion de ${testType === 'height' ? 'Estatura' : (testTypeMap[testType] || testType)}.`;
                          chartWrapper.appendChild(messageContainer); // Anadir mensaje al wrapper
                     }

                     reportContentRow.appendChild(chartWrapper); // Anadir contenedor de grafico a la fila
                     sectionItem.appendChild(reportContentRow); // Anadir la fila de contenido a la seccion


                     individualResultsContainer.appendChild(sectionItem);
                 }

                 // Analisis de evolucion (ejemplo simple)
                 let analysisHtml = '<h4 class="text-lg font-semibold mt-6 mb-2">Analisis de Evolucion</h4><p>Analisis de la evolucion del alumno basado en los resultados de las pruebas:</p><ul>';
                 let hasAnalyzedTests = false; // Bandera para saber si se pudo analizar alguna prueba
                 for (const testType in groupedRecords) {
                     const records = groupedRecords[testType];
                      const recordsWithValidResults = records.filter(record => record.result !== undefined && record.result !== null && !isNaN(record.result));

                     if (recordsWithValidResults.length > 1) {
                         hasAnalyzedTests = true;
                         // Usar los resultados del primer y ultimo registro valido para el analisis
                         const firstResult = recordsWithValidResults[0].result;
                         const lastResult = recordsWithValidResults[recordsWithValidResults.length - 1].result;
                         const testName = testType === 'height' ? 'Estatura' : (testTypeMap[testType] || testType);

                         analysisHtml += `<li><strong>${testName}:</strong> `;
                         if (testType === 'speed30m' || testType === 'run500m') { // Menor es mejor para velocidad y 500m
                             let unit = 's';
                             if (lastResult < firstResult) {
                                 analysisHtml += `Ha mejorado su tiempo (${firstResult}${unit} -> ${lastResult}${unit}). Excelente progreso!`;
                             } else if (lastResult > firstResult) {
                                 analysisHtml += `Su tiempo ha aumentado (${firstResult}${unit} -> ${lastResult}${unit}). Podria necesitar trabajar en su velocidad/resistencia.`;
                             } else {
                                 analysisHtml += `Su tiempo se ha mantenido constante (${firstResult}${unit}).`;
                             }
                         } else if (testType === 'longJump' || testType === 'height' || testType === 'flexibility' || testType === 'situps30s' || testType === 'obliqueSitups30s' || testType === 'ropeJumps1min' || testType === 'pushups30s') { // Mayor es mejor para salto, estatura, flexibilidad y repeticiones
                              let unit = '';
                              switch(testType) {
                                   case 'height': unit = 'cm'; break;
                                   case 'longJump': unit = 'm'; break;
                                   case 'flexibility': unit = 'cm'; break;
                                   case 'situps30s':
                                   case 'obliqueSitups30s':
                                   case 'ropeJumps1min':
                                   case 'pushups30s': unit = ' repeticiones'; break;
                                   default: unit = '';
                              }
                              if (lastResult > firstResult) {
                                  analysisHtml += `Ha mejorado su ${testName.toLowerCase()} (${firstResult}${unit} -> ${lastResult}${unit}). Buen trabajo!`;
                              } else if (lastResult < firstResult) {
                                   analysisHtml += `Su ${testName.toLowerCase()} ha disminuido (${firstResult}${unit} -> ${lastResult}${unit}). Podria ser un error de registro o necesita trabajar en la tecnica.`;
                              } else {
                                  analysisHtml += `Su ${testName.toLowerCase()} se ha mantenido constante (${firstResult}${unit}).`;
                              }
                         }
                         analysisHtml += '</li>';
                     } else {
                         // Si solo hay un registro valido, no se puede analizar la evolucion para esta prueba
                         analysisHtml += `<li><strong>${testType === 'height' ? 'Estatura' : (testTypeMap[testType] || testType)}:</strong> Se necesitan al menos 2 registros con resultados validos para una prueba o estatura para analizar la evolucion de esta prueba.</li>`;
                     }
                 }
                 analysisHtml += '</ul>';
                  if (!hasAnalyzedTests) {
                      // Si no se pudo analizar ninguna prueba con multiples registros validos
                      analysisHtml = '<h4 class="text-lg font-semibold mt-6 mb-2">Analisis de Evolucion</h4><p>Se necesitan al menos 2 registros con resultados validos para una prueba o estatura para analizar la evolucion.</p>';
                  }
                 evolutionAnalysisDiv.innerHTML = analysisHtml;

                  // No necesitamos attachRecordButtonListeners aqui si usamos delegacion en el tbody
             }

             // Funcion para mostrar el comparativo (solo mejores resultados, resumen y grafico)
             function displayComparisonResults() {
                 const filters = getComparisonFilters();
                 const selectedTestType = filters.testType;
                 const selectedSchools = filters.schools;
                 const selectedDistricts = filters.districts;


                 // Limpiar tabla, estadisticas, resumen y grafico si no hay prueba seleccionada
                 if (!selectedTestType) {
                     comparisonResultsDiv.classList.remove('hidden');
                     comparisonTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">Por favor, selecciona un tipo de prueba para el comparativo.</td></tr>';
                     averageResultSpan.textContent = '-'; // Limpiar el span del promedio
                      advancedComparisonSummaryDiv.classList.add('hidden'); // Ocultar resumen avanzado
                      comparisonChartContainer.classList.add('hidden'); // Ocultar contenedor del grafico
                      if (comparisonChartInstance) {
                          comparisonChartInstance.destroy(); // Destruir instancia anterior del grafico
                          comparisonChartInstance = null;
                      }
                     return;
                 }

                 // 1. Filtrar registros por todos los filtros aplicados (incluyendo testType, schools, districts)
                 let filteredRecords = allRecords.filter(record => {
                     let passesGeneralFilters = true;
                     if (filters.age && record.age !== undefined && record.age !== null && record.age !== parseInt(filters.age)) passesGeneralFilters = false;
                     if (filters.sex && record.sex && record.sex !== filters.sex) passesGeneralFilters = false;
                     if (filters.course && record.course && record.course !== filters.course) passesGeneralFilters = false;

                      // Filtrar por Escuelas seleccionadas (si hay alguna seleccionada y no es "Todas")
                     if (filters.schools && filters.schools.length > 0) {
                          if (!record.school || !filters.schools.includes(record.school)) {
                              passesGeneralFilters = false;
                          }
                     }

                      // Filtrar por Distritos seleccionados (si hay alguno seleccionado y no es "Todos")
                     if (filters.districts && filters.districts.length > 0) {
                          if (!record.district || !filters.districts.includes(record.district)) {
                              passesGeneralFilters = false;
                          }
                     }


                     // Ensure the record is for the selected test type and has a valid result
                     return passesGeneralFilters && record.testType === selectedTestType && record.result !== undefined && record.result !== null && !isNaN(record.result);
                 });


                 // 2. Agrupar registros por identidad de alumno (Nombre, Curso, Escuela, Distrito)
                 const groupedRecordsByIdentity = filteredRecords.reduce((acc, record) => {
                     const identityKey = `${record.name}|${record.course}|${record.school}|${record.district}`;
                     if (!acc[identityKey]) {
                         acc[identityKey] = [];
                     }
                     acc[identityKey].push(record);
                     return acc;
                 }, {});

                 // 3. Obtener el mejor resultado para cada identidad de alumno
                 const bestRecordsForComparison = Object.values(groupedRecordsByIdentity).map(records => {
                     // Determine if lower is better for this test type
                     const isLowerBetter = (selectedTestType === 'speed30m' || selectedTestType === 'run500m');

                     // Sort records to find the best (oldest date first as tie-breaker if results are equal)
                     records.sort((a, b) => {
                         if (a.result === b.result) {
                             return new Date(a.date) - new Date(a.date); // Older date first for ties
                         }
                         if (isLowerBetter) {
                             return a.result - b.result; // Lower result is better
                         } else {
                             return b.result - a.result; // Higher result is better
                         }
                     });
                     return records[0]; // The first record after sorting is the best
                 });

                 // 4. Calcular el promedio general de los mejores resultados
                 let totalResults = 0;
                 let validResultCount = 0;
                 bestRecordsForComparison.forEach(record => {
                      if (record.result !== undefined && record.result !== null && !isNaN(record.result)) {
                           totalResults += record.result;
                           validResultCount++;
                      }
                 });

                 const average = validResultCount > 0 ? totalResults / validResultCount : 0;

                 // Mostrar el promedio general en el span
                 if (validResultCount > 0) {
                      averageResultSpan.textContent = average.toFixed(2); // Mostrar con 2 decimales
                 } else {
                      averageResultSpan.textContent = '-';
                 }

                 // 5. Calcular y mostrar el resumen comparativo por grupo (Escuela o Distrito) y generar grafico
                 summaryListUl.innerHTML = ''; // Limpiar lista anterior
                 advancedComparisonSummaryDiv.classList.add('hidden'); // Ocultar por defecto
                 comparisonChartContainer.classList.add('hidden'); // Ocultar contenedor del grafico
                 if (comparisonChartInstance) {
                     comparisonChartInstance.destroy(); // Destruir instancia anterior del grafico
                     comparisonChartInstance = null;
                 }


                 // Decidir por que agrupar (Escuela si hay multiples escuelas seleccionadas, Distrito si hay multiples distritos seleccionados y no multiples escuelas)
                 let groupBy = null;
                 let groupNames = []; // Para las etiquetas del grafico
                 let groupAverages = []; // Para los datos del grafico
                 let groupBackgroundColors = []; // Para los colores del grafico

                 // Check if multiple schools are selected (excluding the "Todas" option)
                 const multipleSchoolsSelected = selectedSchools.length > 1 || (selectedSchools.length === 1 && selectedSchools[0] !== "");
                 // Check if multiple districts are selected (excluding the "Todos" option)
                 const multipleDistrictsSelected = selectedDistricts.length > 1 || (selectedDistricts.length === 1 && selectedDistricts[0] !== "");


                 if (selectedSchools.length > 0 && !multipleDistrictsSelected) { // Agrupar por escuela si hay escuelas seleccionadas y no multiples distritos
                      groupBy = 'school';
                      advancedComparisonSummaryDiv.querySelector('h4').textContent = 'Resumen Comparativo por Escuela';
                 } else if (selectedDistricts.length > 0 && !multipleSchoolsSelected) { // Agrupar por distrito si hay distritos seleccionados y no multiples escuelas
                      groupBy = 'district';
                      advancedComparisonSummaryDiv.querySelector('h4').textContent = 'Resumen Comparativo por Distrito';
                 } else if (selectedSchools.length > 0 && selectedDistricts.length > 0) {
                      // Si se seleccionan multiples escuelas Y multiples distritos, ¿que agrupar?
                      // Por ahora, no agrupamos en este caso para evitar complejidad excesiva.
                      // Podriamos anadir una opcion para que el usuario elija la agrupacion.
                      console.warn("Multiple schools and districts selected. Skipping grouped comparison summary.");
                      groupBy = null; // No agrupar
                 }


                 if (groupBy) {
                      const groupedSummary = bestRecordsForComparison.reduce((acc, record) => {
                           const key = record[groupBy] || 'Desconocido';
                           if (!acc[key]) {
                               acc[key] = { total: 0, count: 0, name: key };
                           }
                            if (record.result !== undefined && record.result !== null && !isNaN(record.result)) {
                                acc[key].total += record.result;
                                acc[key].count++;
                            }
                           return acc;
                      }, {});

                      const summaryItems = Object.values(groupedSummary).map(group => {
                           const groupAverage = group.count > 0 ? group.total / group.count : 0;
                           return { name: group.name, average: groupAverage, count: group.count };
                      });

                      // Ordenar resumen por promedio (ascendente para tiempo, descendente para otros)
                      const isLowerBetter = (selectedTestType === 'speed30m' || selectedTestType === 'run500m');
                      summaryItems.sort((a, b) => {
                           if (a.average === b.average) return 0;
                           if (isLowerBetter) {
                                return a.average - b.average; // Menor promedio primero
                           } else {
                                return b.average - a.average; // Mayor promedio primero (corregido el ordenamiento)
                           }
                      });


                      summaryItems.forEach(item => {
                           const li = document.createElement('li');
                           li.innerHTML = `<strong>${item.name}:</strong> Promedio ${item.average.toFixed(2)} (${item.count} alumnos)`;
                           summaryListUl.appendChild(li);

                           // Preparar datos para el grafico
                           groupNames.push(item.name);
                           groupAverages.push(item.average);
                           // Asignar colores de barra (puedes personalizar esta logica)
                           groupBackgroundColors.push(getRandomColor()); // Usar colores aleatorios por ahora
                      });

                      // Mostrar el resumen si hay al menos 2 grupos con resultados
                      if (summaryItems.filter(item => item.count > 0).length >= 2) {
                           advancedComparisonSummaryDiv.classList.remove('hidden');

                            // Generar el grafico de barras
                           comparisonChartContainer.classList.remove('hidden');
                           const ctx = comparisonChartCanvas.getContext('2d');

                            // Destruir instancia anterior si existe
                            if (comparisonChartInstance) {
                                comparisonChartInstance.destroy();
                                comparisonChartInstance = null;
                            }

                           comparisonChartInstance = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: groupNames, // Nombres de escuelas/distritos
                                    datasets: [{
                                        label: `Promedio de ${testTypeMap[selectedTestType] || selectedTestType}`,
                                        data: groupAverages, // Promedios
                                        backgroundColor: groupBackgroundColors, // Colores de barra
                                        borderColor: groupBackgroundColors.map(color => color.replace('0.8', '1')), // Borde mas opaco
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: `Resultado (${testTypeMap[selectedTestType] || selectedTestType})`
                                            }
                                        },
                                        x: {
                                            title: {
                                                display: true,
                                                text: groupBy === 'school' ? 'Escuela' : 'Distrito'
                                            }
                                        }
                                    },
                                     plugins: {
                                         legend: {
                                             display: false // Ocultar leyenda si solo hay un dataset
                                         }
                                     }
                                }
                           });
                      }
                 }


                 // 6. Ordenar los mejores resultados para mostrar en la tabla
                 bestRecordsForComparison.sort((a, b) => {
                     const aValue = a[currentComparisonSortColumn];
                     const bValue = b[currentComparisonSortColumn];

                     if (aValue === undefined || aValue === null) return currentComparisonSortDirection === 'asc' ? 1 : -1;
                     if (bValue === undefined || bValue === null) return currentComparisonSortDirection === 'asc' ? -1 : 1;

                     if (currentComparisonSortColumn === 'date') {
                         return currentComparisonSortDirection === 'asc' ? new Date(aValue) - new Date(bValue) : new Date(bValue) - new Date(aValue);
                     } else if (currentComparisonSortColumn === 'result' || currentComparisonSortColumn === 'age' || currentComparisonSortColumn === 'height') {
                          // Para resultado, edad y estatura, ordenar numericamente
                          // Para velocidad (speed30m) y 500m (run500m), menor es mejor, pero el ordenamiento 'desc' lo maneja si el resultado es el 'mejor'
                         return currentComparisonSortDirection === 'asc' ? aValue - bValue : bValue - aValue;
                     }
                      else {
                         // Ordenamiento alfabetico para otros campos
                         const aStr = String(aValue).toLowerCase();
                         const bStr = String(bValue).toLowerCase();
                         if (aStr < bStr) return currentComparisonSortDirection === 'asc' ? -1 : 1;
                         if (aStr > bStr) return currentComparisonSortDirection === 'asc' ? 1 : -1;
                         return 0;
                     }
                 });


                 // 7. Aplicar logica de medallas a los mejores resultados (solo si no se esta comparando por escuela/distrito)
                 // Las medallas solo tienen sentido en una lista general, no cuando se agrupa por escuela/distrito
                 if (!groupBy && bestRecordsForComparison.length >= 3) {
                      // Determine if lower is better for this test type
                      const isLowerBetter = (selectedTestType === 'speed30m' || selectedTestType === 'run500m');

                      // Sort the best records again specifically for medal assignment (based on result only)
                       bestRecordsForComparison.sort((a, b) => {
                           if (isLowerBetter) {
                               return a.result - b.result; // Menor primero
                           } else {
                               return b.result - a.result; // Mayor primero
                           }
                       });

                      // Assign medals to the top 3 (if they exist)
                      if (bestRecordsForComparison[0]) bestRecordsForComparison[0].medal = 'gold';
                      if (bestRecordsForComparison[1]) bestRecordsForComparison[1].medal = 'silver';
                      if (bestRecordsForComparison[2]) bestRecordsForComparison[2].medal = 'bronze';

                       // Restore the original sorting order after assigning medals if needed,
                       // or just proceed with the medal-assigned array if the desired display order
                       // is the same as the medal order (best result first).
                       // Let's re-sort by the currentComparisonSortColumn for consistency with the header clicks.
                        bestRecordsForComparison.sort((a, b) => {
                            const aValue = a[currentComparisonSortColumn];
                            const bValue = b[currentComparisonSortColumn];

                            if (aValue === undefined || aValue === null) return currentComparisonSortDirection === 'asc' ? 1 : -1;
                            if (bValue === undefined || bValue === null) return currentComparisonSortDirection === 'asc' ? -1 : 1;

                            if (currentComparisonSortColumn === 'date') {
                                return currentComparisonSortDirection === 'asc' ? new Date(aValue) - new Date(bValue) : new Date(bValue) - new Date(aValue);
                            } else if (currentComparisonSortColumn === 'result' || currentComparisonSortColumn === 'age' || currentComparisonSortColumn === 'height') {
                                return currentComparisonSortDirection === 'asc' ? aValue - bValue : bValue - aValue;
                            }
                             else {
                                const aStr = String(aValue).toLowerCase();
                                const bStr = String(bValue).toLowerCase();
                                if (aStr < bStr) return currentComparisonSortDirection === 'asc' ? -1 : 1;
                                if (aStr > bStr) return currentComparisonSortDirection === 'asc' ? 1 : -1;
                                return 0;
                            }
                        });
                 } else {
                      // Si se esta agrupando o no hay suficientes alumnos, limpiar medallas
                      bestRecordsForComparison.forEach(record => delete record.medal);
                 }


                 // 8. Llenar la tabla con los mejores resultados
                 comparisonTableBody.innerHTML = ''; // Limpiar tabla anterior

                 if (bestRecordsForComparison.length === 0) {
                     comparisonTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">No se encontraron mejores resultados para los filtros seleccionados.</td></tr>';
                 } else {
                      bestRecordsForComparison.forEach(record => {
                          const row = document.createElement('tr');
                          // Anadir emoji de medalla si existe
                          const resultCellContent = record.result !== undefined && record.result !== null ? record.result : '-';
                          const medalEmoji = record.medal === 'gold' ? ' 🥇' : record.medal === 'silver' ? ' 🥈' : record.medal === 'bronze' ? ' 🥉' : '';

                          // Agregar la medalla al nombre si existe
                           const nameCellContent = record.name || '-';
                           const nameWithMedal = record.medal ? `${nameCellContent} ${medalEmoji}` : nameCellContent;


                          row.innerHTML = `
                              <td>${nameWithMedal}</td>
                              <td>${record.age || '-'}</td>
                              <td>${record.sex ? (record.sex.charAt(0).toUpperCase() + record.sex.slice(1)) : '-'}</td> <td>${record.course || '-'}</td>
                              <td>${record.school || '-'}</td>
                              <td>${record.district || '-'}</td>
                              <td>${formatDate(record.date)}</td>
                              <td>${record.academicYear || '-'}</td> <td>${resultCellContent}</td> `;
                          comparisonTableBody.appendChild(row);
                      });
                 }


                 comparisonResultsDiv.classList.remove('hidden');
             }

              // Funcion auxiliar para obtener un color aleatorio (para las barras del grafico)
              function getRandomColor() {
                  const letters = '0123456789ABCDEF';
                  let color = '#';
                  for (let i = 0; i < 6; i++) {
                      color += letters[Math.floor(Math.random() * 16)];
                  }
                  // Convertir a formato RGBA con opacidad
                  const r = parseInt(color.substring(1, 3), 16);
                  const g = parseInt(color.substring(3, 5), 16);
                  const b = parseInt(color.substring(5, 7), 16);
                  return `rgba(${r}, ${g}, ${b}, 0.8)`; // Opacidad del 80%
              }


             // Funcion para manejar el ordenamiento en la tabla de comparativo
             function handleComparisonSort(event) {
                 const column = event.currentTarget.dataset.sort;

                 if (currentComparisonSortColumn === column) {
                     // Si es la misma columna, cambiar la direccion
                     currentComparisonSortDirection = currentComparisonSortDirection === 'asc' ? 'desc' : 'asc';
                 } else {
                     // Si es una nueva columna, establecerla y ordenar por defecto
                     currentComparisonSortColumn = column;
                     // Determinar direccion por defecto:
                     // - 'result': depende del tipo de prueba (menor es mejor para tiempo)
                     // - 'age', 'height': numerico descendente (mayor primero)
                     // - Otros: alfabetico ascendente
                     const selectedTestType = filterTestTypeSelect.value;
                     if (column === 'result' && selectedTestType) {
                         const isLowerBetter = (selectedTestType === 'speed30m' || selectedTestType === 'run500m');
                         currentComparisonSortDirection = isLowerBetter ? 'asc' : 'desc';
                     } else if (column === 'age' || column === 'height') {
                         currentComparisonSortDirection = 'desc';
                     } else {
                         currentComparisonSortDirection = 'asc';
                     }
                 }

                 // Actualizar los iconos de ordenamiento
                 comparisonTableHeaders.forEach(header => {
                     const icon = header.querySelector('.fas'); // Asumiendo que el icono es el unico elemento fas
                     if (icon) {
                          icon.classList.remove('fa-sort-up', 'fa-sort-down', 'fa-sort');
                          if (header.dataset.sort === currentComparisonSortColumn) {
                              icon.classList.add(currentComparisonSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                          } else {
                               icon.classList.add('fa-sort'); // Icono por defecto si no esta ordenado
                          }
                     }
                 });


                 // Volver a mostrar los resultados con el nuevo ordenamiento
                 displayComparisonResults();
             }


             // Funcion para exportar datos a JSON
             function exportToJson() {
                 if (allRecords.length === 0) {
                     console.error('No hay datos para exportar.');
                     return;
                 }
                 try {
                     const dataStr = JSON.stringify(allRecords, null, 2); // Formato legible
                     const blob = new Blob([dataStr], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = 'registros_educacion_fisica.json';
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);
                 } catch (e) {
                      console.error("Error exporting JSON:", e);
                      console.error("Ocurrio un error al exportar los datos a JSON.");
                 }
             }

             // Funcion para exportar datos a CSV
             function exportToCsv() {
                 if (allRecords.length === 0) {
                     console.error('No hay datos para exportar.');
                     return;
                 }
                 try {
                     // Usar las claves mapeadas a espanol para los encabezados
                     const headers = Object.values(csvHeadersMap);

                     // Crear el contenido CSV
                     let csvContent = headers.join(',') + '\n'; // Encabezados

                     allRecords.forEach(record => {
                         const row = Object.keys(csvHeadersMap).map(key => {
                             let value = record[key];
                             if (value === undefined || value === null) {
                                 value = ''; // Reemplazar undefined/null con cadena vacia
                             }
                              // Formatear la fecha a DD/MM/YYYY para el CSV
                              if (key === 'date' && value) {
                                   value = formatDate(value);
                              }
                             // Manejar comas y comillas en los valores:
                             // 1. Reemplazar comillas dobles por dos comillas dobles.
                             // 2. Si el valor contiene coma, comilla doble o salto de linea, encerrar entre comillas dobles.
                             if (typeof value === 'string') {
                                  value = value.replace(/"/g, '""'); // Escape double quotes
                                  if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                                       value = `"${value}"`; // Enclose in double quotes if needed
                                  }
                             }
                             return value;
                         }).join(',');
                         csvContent += row + '\n'; // Anadir la fila completa
                     });

                     const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = 'registros_educacion_fisica.csv';
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);
                 } catch (e) {
                      console.error("Error exporting CSV:", e);
                      console.error("Ocurrio un error al exportar los datos a CSV.");
                 }
             }

             // Funcion para importar datos desde un archivo CSV con manejo basico de comillas
             function parseCsv(csvString) {
                  const lines = csvString.split(/\r\n|\n/).filter(line => line.trim() !== ''); // Split lines, handle different line endings

                  if (lines.length === 0) {
                      return []; // Empty file
                  }

                  const headers = [];
                  // Simple state machine for parsing headers (handles quoted headers)
                  let currentHeader = '';
                  let inQuote = false;
                  for (let i = 0; i < lines[0].length; i++) {
                      const char = lines[0][i];
                      if (char === '"') {
                          inQuote = !inQuote;
                      } else if (char === ',' && !inQuote) {
                          headers.push(currentHeader.trim());
                          currentHeader = '';
                      } else {
                          currentHeader += char;
                      }
                  }
                  headers.push(currentHeader.trim()); // Add the last header


                  const records = [];
                  for (let i = 1; i < lines.length; i++) {
                      const line = lines[i];
                      const values = [];
                      let currentValue = '';
                      inQuote = false; // Reset quote state for each line

                      for (let j = 0; j < line.length; j++) {
                          const char = line[j];
                          if (char === '"') {
                               // Handle escaped quotes ("")
                               if (inQuote && line[j + 1] === '"') {
                                   currentValue += '"';
                                   j++; // Skip the next quote
                               } else {
                                   inQuote = !inQuote;
                               }
                          } else if (char === ',' && !inQuote) {
                              values.push(currentValue.trim());
                              currentValue = '';
                          } else {
                              currentValue += char;
                          }
                      }
                      values.push(currentValue.trim()); // Add the last value

                       if (values.length !== headers.length) {
                           console.warn(`Skipping row ${i + 1} due to incorrect column count: ${line}`);
                           continue; // Skip rows with incorrect column count
                       }


                      const record = {};
                      headers.forEach((header, index) => {
                          // Find the internal property name based on the Spanish header
                          const propName = Object.keys(csvHeadersMap).find(key => csvHeadersMap[key] === header);

                          if (propName) { // Only add if we have a corresponding internal property name
                              let value = values[index];

                              // Attempt to convert to number if it looks numeric
                              if (propName === 'age' || propName === 'height' || propName === 'result') {
                                   const numValue = parseFloat(value);
                                   value = isNaN(numValue) ? null : numValue; // Use null for invalid numbers
                              }
                               // Parse date if the column is 'date' (assumes DD/MM/YYYY or YYYY-MM-DD)
                               if (propName === 'date' && value) {
                                    value = parseDateToISO(value); // Convert to YYYY-MM-DD
                               }
                               // Ensure 'id' exists and is unique
                               if (propName === 'id' && !value) {
                                    value = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                               }

                              record[propName] = value;
                          } else {
                              console.warn(`Unknown header "${header}" in CSV. Skipping column.`);
                          }
                      });

                       // Ensure mandatory fields exist after parsing and add a unique ID if missing
                       if (!record.name || !record.testType || record.result === undefined || record.result === null) {
                            console.warn(`Skipping record due to missing mandatory fields: ${JSON.stringify(record)}`);
                            continue; // Skip records without mandatory fields
                       }
                        if (!record.id) {
                             record.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                        }
                        // Recalculate academic year based on parsed date
                        record.academicYear = getAcademicYear(record.date);


                      records.push(record);
                  }
                  return records;
             }


             // Funcion para importar datos desde un archivo
             function importData(file) {
                 const reader = new FileReader();

                 reader.onload = function(e) {
                     try {
                         const content = e.target.result;
                         let importedRecords = [];

                         if (file.name.endsWith('.json')) {
                             importedRecords = JSON.parse(content);
                             // Basic validation for JSON structure
                             if (!Array.isArray(importedRecords) || importedRecords.some(record => !record.id || !record.name || !record.testType || record.result === undefined)) {
                                 console.error('El archivo JSON no tiene el formato esperado.');
                                 return;
                             }
                              // Ensure academicYear is set for imported JSON records if missing
                              importedRecords.forEach(record => {
                                   if (!record.academicYear && record.date) {
                                        record.academicYear = getAcademicYear(record.date);
                                   } else if (!record.academicYear) {
                                        record.academicYear = '-';
                                   }
                              });

                         } else if (file.name.endsWith('.csv')) {
                             importedRecords = parseCsv(content);
                             if (importedRecords.length === 0) {
                                  console.error('El archivo CSV esta vacio o no se pudieron parsear registros validos.');
                                  return;
                             }
                         } else {
                             console.error('Formato de archivo no soportado. Por favor, selecciona un archivo .json o .csv.');
                             return;
                         }

                         // Fusionar o reemplazar datos (aqui simplemente reemplazamos por simplicidad)
                         allRecords = importedRecords;
                         saveRecords();
                         console.log('Datos importados correctamente.');
                         // Recargar la interfaz
                         populateFilterOptions();
                         filterAndDisplayStudents();
                         // Navegar a la seccion de ver alumnos si no estabamos alli
                         if (currentSectionId !== 'view-records-section') {
                             navigateToSection('view-records-section');
                         } else {
                              // Si ya estabamos en ver alumnos, simplemente actualizar la vista
                              // Obtener la identidad del alumno actualmente seleccionado antes de limpiar el selector
                              const currentStudentIdentityJson = selectStudentSelect.value;
                              if (currentStudentIdentityJson) {
                                   const currentStudentIdentity = JSON.parse(currentStudentIdentityJson);
                                   // Intentar re-seleccionar el mismo alumno si existe despues de la importacion
                                   const reselectedIdentity = filteredStudentList.find(student =>
                                        student.name === currentStudentIdentity.name &&
                                        student.course === currentStudentIdentity.course &&
                                        student.school === currentStudentIdentity.school &&
                                        student.district === currentStudentIdentity.district
                                   );
                                   if (reselectedIdentity) {
                                        const reselectedIdentityJson = JSON.stringify(reselectedIdentity);
                                        selectStudentSelect.value = reselectedIdentityJson;
                                        displayStudentRecords(reselectedIdentity);
                                   } else {
                                        // Si el alumno seleccionado ya no existe despues de la importacion
                                        studentRecordsDiv.classList.add('hidden');
                                        selectedStudentNameDisplay.textContent = '';
                                        recordsTableBody.innerHTML = '';
                                         studentRecordsDivData.dataset.currentStudentIdentity = '';
                                          // Limpiar el analisis
                                          analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                                           generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                                           // Limpiar iconos de distincion Top 1 en el nombre
                                           const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                                           if (existingTop1Icons) existingTop1Icons.remove();

                                   }
                              } else {
                                   // Si no habia ningun alumno seleccionado
                                   studentRecordsDiv.classList.add('hidden');
                                   selectedStudentNameDisplay.textContent = '';
                                   recordsTableBody.innerHTML = '';
                                    studentRecordsDivData.dataset.currentStudentIdentity = '';
                                     // Limpiar el analisis
                                     analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                                      generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                                      // Limpiar iconos de distincion Top 1 en el nombre
                                      const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                                      if (existingTop1Icons) existingTop1Icons.remove();
                              }
                         }


                     } catch (error) {
                         console.error("Error importing data:", error);
                         console.error('Ocurrio un error al procesar el archivo. Asegurate de que el formato sea correcto.');
                     }
                 };

                 reader.onerror = function() {
                     console.error('Ocurrio un error al leer el archivo.');
                 };

                 reader.readAsText(file);
             }


             // Funcion para imprimir la ficha del alumno (seccion de reporte)
             function printReport() {
                 // La logica de impresion se maneja principalmente con CSS @media print
                 window.print();
             }

             // Funcion para imprimir la lista de alumnos filtrada
             function printFilteredList() {
                  const filters = getViewFilters();
                  // Obtener los alumnos unicos que cumplen con los filtros
                  const filteredStudents = allRecords.filter(record => {
                      // Apply general filters (age, sex, course, school, district, minHeight)
                      let passesFilters = true;
                      if (filters.age && record.age !== undefined && record.age !== null && record.age !== parseInt(filters.age)) passesFilters = false;
                      if (filters.sex && record.sex && record.sex !== filters.sex) passesFilters = false;
                       if (filters.minHeight !== undefined && filters.minHeight !== null && filters.minHeight !== '') {
                           const minHeightValue = parseFloat(filters.minHeight);
                           if (!isNaN(minHeightValue) && (record.height === undefined || record.height === null || parseFloat(record.height) < minHeightValue)) {
                               passesFilters = false;
                           }
                       }
                      if (filters.course && record.course && record.course !== filters.course) passesFilters = false;
                      if (filters.school && record.school && record.school !== filters.school) passesFilters = false;
                      if (filters.district && record.district && record.district !== filters.district) passesFilters = false;
                      return passesFilters;
                  })
                  .filter((record, index, self) => // Obtener alumnos unicos por identidad combinada
                      index === self.findIndex((r) =>
                           r.name === record.name &&
                           r.course === record.course &&
                           r.school === record.school &&
                           r.district === record.district
                      )
                  );


                 if (filteredStudents.length === 0) {
                     console.error('No hay alumnos en la lista filtrada para imprimir.');
                     return;
                 }

                 // Llenar la tabla temporal para imprimir
                 printableStudentListTableBody.innerHTML = '';
                 filteredStudents.forEach(student => {
                      // Encontrar el registro mas reciente para obtener los datos mas actualizados
                      const studentRecords = allRecords.filter(record =>
                           record.name === student.name &&
                           record.course === student.course &&
                           record.school === student.school &&
                           record.district === student.district
                      );
                      studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                      const studentData = studentRecords.length > 0 ? studentRecords[0] : student; // Usar el objeto student si no hay registros fechados


                      const row = document.createElement('tr');
                          row.innerHTML = `
                              <td>${studentData.name || '-'}</td>
                              <td>${studentData.age || '-'}</td>
                              <td>${studentData.sex ? (studentData.sex.charAt(0).toUpperCase() + studentData.sex.slice(1)) : '-'}</td>
                              <td>${studentData.height || '-'}</td>
                              <td>${studentData.height || '-'}</td>
                              <td>${studentData.course || '-'}</td>
                              <td>${studentData.school || '-'}</td>
                              <td>${studentData.district || '-'}</td>
                               <td>${studentData.academicYear || '-'}</td> `;
                          printableStudentListTableBody.appendChild(row);

                 });

                 // Activar la impresion
                 window.print();

                 // La tabla temporal se oculta automaticamente con CSS @media print
             }


             // --- Funciones de Navegacion ---

             // Funcion para navegar a una seccion especifica
             function navigateToSection(sectionId) {
                 // Ocultar todas las secciones
                 sections.forEach(section => {
                     section.classList.add('hidden');
                 });

                 // Mostrar la seccion deseada
                 const targetSection = sectionMap[sectionId];
                 if (targetSection) {
                     targetSection.classList.remove('hidden');
                     currentSectionId = sectionId; // Actualizar la seccion actual
                     sessionStorage.setItem('currentSectionId', currentSectionId); // Guardar en sessionStorage

                     // Actualizar el historial de navegacion
                     if (navigationHistory.length === 0 || navigationHistory[navigationHistory.length - 1] !== sectionId) {
                          navigationHistory.push(sectionId);
                          sessionStorage.setItem('navigationHistory', JSON.stringify(navigationHistory)); // Guardar en sessionStorage
                     }


                     // Actualizar el estado del boton Atras
                     updateBackButtonState();

                      // Si navegamos a la seccion de ver alumnos, refrescar la lista de alumnos
                     if (sectionId === 'view-records-section') {
                          populateFilterOptions(); // Asegurarse de que los filtros esten actualizados
                          filterAndDisplayStudents(); // Mostrar alumnos filtrados
                          // Si ya habia un alumno seleccionado, intentar re-seleccionar
                          const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                          if (currentStudentIdentityJson) {
                               const currentStudentIdentity = JSON.parse(currentStudentIdentityJson);
                               // Buscar la identidad en la nueva lista filtrada
                               const reselectedIdentity = filteredStudentList.find(student =>
                                    student.name === currentStudentIdentity.name &&
                                    student.course === student.course &&
                                    student.school === student.school &&
                                    student.district === student.district
                               );
                               if (reselectedIdentity) {
                                    const reselectedIdentityJson = JSON.stringify(reselectedIdentity);
                                    selectStudentSelect.value = reselectedIdentityJson;
                                    displayStudentRecords(reselectedIdentity);
                               } else {
                                    // Si el alumno seleccionado ya no esta en la lista filtrada
                                    studentRecordsDiv.classList.add('hidden');
                                    selectedStudentNameDisplay.textContent = '';
                                    recordsTableBody.innerHTML = '';
                                     studentRecordsDivData.dataset.currentStudentIdentity = '';
                                      // Limpiar el analisis
                                      analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                                       generalOlympicDistincionesUl.innerHTML = ''; // Limpiar distinciones generales
                                       // Limpiar iconos de distincion Top 1 en el nombre
                                       const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                                       if (existingTop1Icons) existingTop1Icons.remove();

                               }
                          } else {
                               studentRecordsDiv.classList.add('hidden'); // Ocultar seccion de registros si no hay alumno seleccionado
                                // Limpiar el analisis
                                analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                                 generalOlympicDistincionesUl.innerHTML = ''; // Limpiar distinciones generales
                                 // Limpiar iconos de distincion Top 1 en el nombre
                                 const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                                 if (existingTop1Icons) existingTop1Icons.remove();
                          }
                     }
                      // Si navegamos a la seccion de comparativo, refrescar los filtros
                      if (sectionId === 'comparison-section') {
                           populateFilterOptions(); // Asegurarse de que los filtros esten actualizados
                           comparisonResultsDiv.classList.add('hidden'); // Ocultar resultados anteriores
                           averageResultSpan.textContent = '-'; // Limpiar promedio
                            advancedComparisonSummaryDiv.classList.add('hidden'); // Ocultar resumen avanzado
                             if (comparisonChartInstance) {
                                comparisonChartInstance.destroy(); // Destruir instancia anterior del grafico
                                comparisonChartInstance = null;
                            }
                            comparisonChartContainer.classList.add('hidden'); // Ocultar contenedor del grafico

                      }
                       // Si navegamos a la seccion de agregar registro, limpiar solo los campos de prueba
                       if (sectionId === 'add-record-section') {
                           clearAddRecordFormTestFields(); // Limpiar solo campos de prueba
                            // Ocultar la lista de autocompletado al cambiar de seccion
                           autocompleteResultsUl.classList.remove('visible');
                       }
                       // Si hay una fila editandose inline, cancelar al cambiar de seccion
                       if (editingRow) {
                            // Encuentra el ID del registro desde la fila antes de que se oculte
                            const recordIdToCancel = editingRow.dataset.recordId;
                            handleCancelInlineEdit(editingRow, recordIdToCancel);
                       }


                 } else {
                     console.error(`Seccion con ID ${sectionId} no encontrada.`);
                     // Si la seccion no existe, podriamos redirigir a la pagina principal o mostrar un error
                     navigateToSection('add-record-section'); // Redirigir a la seccion principal por defecto
                 }
             }

              // Funcion para actualizar el estado del boton Atras
              function updateBackButtonState() {
                  if (navigationHistory.length > 1) {
                      backButton.disabled = false;
                  } else {
                      backButton.disabled = true;
                  }
              }

              // Manejador para el clic en el boton Atras
              function handleBackButtonClick() {
                  // Si hay una fila editandose, cancelar la edicion antes de navegar
                  if (editingRow) {
                       handleCancelInlineEdit(editingRow, editingRow.dataset.recordId);
                  }

                  if (navigationHistory.length > 1) {
                      navigationHistory.pop(); // Eliminar la seccion actual del historial
                      const previousSectionId = navigationHistory[navigationHistory.length - 1]; // Obtener la seccion anterior
                       sessionStorage.setItem('navigationHistory', JSON.stringify(navigationHistory)); // Guardar en sessionStorage
                      // Usar navigateToSection para asegurar la logica de mostrar/ocultar y refrescar
                      navigateToSection(previousSectionId);
                  }
              }


             // --- Inicializacion y Event Listeners ---

             // Cargar registros al iniciar
             populateFilterOptions(); // Poblar selectores y datalist al cargar

             // Mostrar la seccion inicial al cargar la pagina
             navigateToSection(currentSectionId);

             // Adjuntar listeners de eventos delegados a las tablas
             attachRecordButtonListeners();


            // Event Listener para agregar registro
            addRecordBtn.addEventListener('click', () => {
                const name = studentNameInput.value.trim();
                const age = parseInt(studentAgeInput.value);
                const sex = studentSexSelect.value;
                const height = parseFloat(studentHeightInput.value);
                const course = studentCourseInput.value.trim();
                const school = studentSchoolSelect.value;
                const district = studentDistrictSelect.value;
                const testType = testTypeSelect.value;
                const date = recordDateInput.value;
                const result = parseFloat(testResultInput.value);

                // Validar campos obligatorios (Nombre, Tipo de Prueba, Fecha, Resultado)
                if (!name || !testType || !date || isNaN(result)) {
                    console.error('Por favor, completa los campos obligatorios: Nombre, Tipo de Prueba, Fecha y Resultado.');
                    return;
                }

                 // Validar campos adicionales si estan llenos
                 if (studentAgeInput.value.trim() !== '' && isNaN(age)) {
                      console.error('Por favor, ingresa una edad valida.');
                      return;
                 }
                  if (studentHeightInput.value.trim() !== '' && isNaN(height)) {
                       console.error('Por favor, ingresa una estatura valida.');
                       return;
                  }
                  // Check if related fields are filled if one of them is used
                   if (studentAgeInput.value.trim() !== '' || studentHeightInput.value.trim() !== '' || studentCourseInput.value.trim() !== '' || studentSchoolSelect.value !== '' || studentDistrictSelect.value !== '') {
                       if (sex === '') { // Usar la variable 'sex' directamente
                           console.error('Por favor, selecciona el sexo del alumno.');
                           return;
                       }
                       if (course === '') { // Usar la variable 'course' directamente
                           console.error('Por favor, ingresa el curso del alumno.');
                           return;
                       }
                        if (school === '') { // Usar la variable 'school' directamente
                            console.error('Por favor, selecciona la escuela del alumno.');
                            return;
                        }
                         if (district === '') { // Usar la variable 'district' directamente
                             console.error('Por favor, selecciona el distrito del alumno.');
                             return;
                         }
                   }


                // Crear un ID unico para el registro
                const id = Date.now().toString() + Math.random().toString(36).substr(2, 5);

                 // Obtener el ciclo lectivo
                 const academicYear = getAcademicYear(date);


                // Crear el objeto de registro
                const newRecord = {
                    id: id,
                    name: name,
                    age: isNaN(age) ? null : age, // Usar null si no es un numero valido
                    sex: sex || null,
                    height: isNaN(height) ? null : height, // Usar null si no es un numero valido
                    course: course || null,
                    school: school || null,
                    district: district || null,
                    testType: testType,
                    date: date,
                    result: result,
                    academicYear: academicYear // Anadir ciclo lectivo al registro
                };

                // Agregar el nuevo registro al array
                allRecords.push(newRecord);

                // Guardar en localStorage
                saveRecords();

                // Limpiar solo los campos de prueba para permitir carga rapida del mismo alumno
                clearAddRecordFormTestFields();

                // Actualizar las opciones de los selectores y datalist
                populateFilterOptions();

                console.log('Registro agregado correctamente.');
            });


             // Event Listeners para Exportar/Importar
             exportJsonBtn.addEventListener('click', exportToJson);
             exportCsvBtn.addEventListener('click', exportToCsv);
             importDataBtn.addEventListener('click', () => importFileInput.click()); // Activar el input de archivo al hacer clic en el boton
             importFileInput.addEventListener('change', (event) => {
                 const file = event.target.files[0];
                 if (file) {
                     importData(file);
                 }
                  importFileInput.value = ''; // Clear the input so the same file can be selected again
             });


            // Event Listener para el campo de busqueda (filtrar alumnos en tiempo real)
            searchInput.addEventListener('input', () => {
                filterAndDisplayStudents(); // Esta funcion ahora maneja ambos (selector y lista de busqueda)
            });

             // Event Listener para el boton de aplicar filtros en "Ver Alumnos"
             applyViewFiltersBtn.addEventListener('click', () => {
                 filterAndDisplayStudents(); // Aplicar filtros y actualizar selector/lista de busqueda
             });

             // Event Listener para el boton de imprimir lista filtrada
             printFilteredListBtn.addEventListener('click', printFilteredList);


            // Event Listener para seleccionar un alumno de la lista de resultados (busqueda)
            searchResultsUl.addEventListener('click', (event) => {
                if (event.target.tagName === 'LI' && event.target.dataset.studentIdentity) {
                    const studentIdentityJson = event.target.dataset.studentIdentity;
                    const studentIdentity = JSON.parse(studentIdentityJson);

                    // Llenar el input de busqueda con la identidad combinada
                     const displayString = `${studentIdentity.name} (${studentIdentity.course || '-'}, ${studentIdentity.school || '-'}, ${studentIdentity.district || '-'})`;
                    searchInput.value = displayString;

                    searchResultsUl.innerHTML = ''; // Limpiar resultados de busqueda
                    searchResultsUl.classList.remove('visible'); // Ocultar lista

                    // Seleccionar en el selector (si existe)
                    selectStudentSelect.value = studentIdentityJson;

                    displayStudentRecords(studentIdentity); // Mostrar registros del alumno
                }
            });

            // Event Listener para seleccionar un alumno del selector
            selectStudentSelect.addEventListener('change', (event) => {
                const studentIdentityJson = event.target.value;
                if (studentIdentityJson) {
                    const studentIdentity = JSON.parse(studentIdentityJson);
                    // Al seleccionar del dropdown, limpiar el input de busqueda y ocultar la lista de busqueda
                    searchInput.value = '';
                    searchResultsUl.innerHTML = '';
                    searchResultsUl.classList.remove('visible');
                    displayStudentRecords(studentIdentity); // Mostrar registros del alumno
                } else {
                    // Si se selecciona la opcion por defecto, ocultar registros
                    studentRecordsDiv.classList.add('hidden');
                    selectedStudentNameDisplay.textContent = '';
                    studentAgeDisplaySpan.textContent = '-';
                    studentSexDisplaySpan.textContent = '-';
                    studentHeightDisplaySpan.textContent = '-';
                    studentCourseDisplaySpan.textContent = '-';
                    studentSchoolDisplaySpan.textContent = '-';
                    studentDistrictDisplaySpan.textContent = '-';
                    recordsTableBody.innerHTML = '';
                     studentRecordsDivData.dataset.currentStudentIdentity = ''; // Limpiar el data attribute
                      // Limpiar el analisis
                      analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                       generalOlympicDistincionesUl.innerHTML = ''; // Limpiar distinciones generales
                       // Limpiar iconos de distincion Top 1 en el nombre
                       const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                       if (existingTop1Icons) existingTop1Icons.remove();
                }
            });

             // Event Listener para el boton de editar datos del alumno
             editStudentDataBtn.addEventListener('click', handleEditStudentDataClick);

             // Event Listener para el boton de guardar datos del alumno
             saveStudentDataBtn.addEventListener('click', handleSaveStudentDataClick);

             // Event Listener para el boton de cancelar edicion de datos del alumno
             cancelStudentDataBtn.addEventListener('click', handleCancelStudentDataClick);


            // Event Listener para el boton de eliminar alumno completo
            deleteStudentBtn.addEventListener('click', handleDeleteStudentClick);

            // Event Listener para el boton de generar reporte
            generateReportBtn.addEventListener('click', () => {
                const currentStudentIdentityJson = studentRecordsDivData.dataset.currentStudentIdentity;
                if (currentStudentIdentityJson) {
                    const studentIdentity = JSON.parse(currentStudentIdentityJson);
                    generateReport(studentIdentity);
                } else {
                    console.error('Por favor, selecciona un alumno para generar la ficha.');
                }
            });

             // Event Listener para el boton de imprimir reporte
             printReportBtn.addEventListener('click', printReport);


            // Event Listener para mostrar comparativo
            showComparisonBtn.addEventListener('click', displayComparisonResults);

             // Event Listeners para ordenar la tabla de comparativo
             comparisonTableHeaders.forEach(header => {
                 header.addEventListener('click', handleComparisonSort);
                  // Anadir icono de ordenamiento por defecto
                 const icon = document.createElement('i');
                 icon.classList.add('fas', 'fa-sort');
                 header.appendChild(icon);
             });

             // Inicializar icono de ordenamiento en la columna por defecto
             const defaultSortHeader = document.querySelector(`#comparison-table th[data-sort="${currentComparisonSortColumn}"]`);
             if (defaultSortHeader) {
                  const icon = defaultSortHeader.querySelector('.fas');
                  if (icon) {
                       icon.classList.remove('fa-sort');
                       icon.classList.add(currentComparisonSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                  }
             }


             // Event Listeners para la navegacion
             navLinks.forEach(link => {
                 link.addEventListener('click', (event) => {
                     event.preventDefault(); // Prevenir el comportamiento por defecto del enlace
                     const targetId = event.target.getAttribute('href').substring(1); // Obtener el ID de la seccion
                      // No agregar al historial si ya estamos en esa seccion
                     if (currentSectionId !== targetId) {
                          navigateToSection(targetId);
                     }
                 });
             });

             // Event Listener para el boton Atras
             backButton.addEventListener('click', handleBackButtonClick);

             // El formulario de edicion individual separado y sus listeners ya no se usan
             // saveEditedRecordBtn.addEventListener('click', handleSaveEditedRecordClick);
             // cancelEditRecordBtn.addEventListener('click', handleCancelEditRecordClick);

             // --- Autocompletado datos del alumno al escribir el nombre en Agregar Registro ---
             studentNameInput.addEventListener('input', () => {
                 const enteredName = studentNameInput.value.trim().toLowerCase();
                 autocompleteResultsUl.innerHTML = ''; // Limpiar resultados anteriores

                 if (enteredName.length > 0) {
                     // Obtener identidades unicas de todos los registros que coinciden con el nombre
                     const matchingIdentities = {};
                     allRecords.filter(record => record.name && record.name.toLowerCase().includes(enteredName)).forEach(record => {
                          const identityKey = `${record.name}|${record.course}|${record.school}|${record.district}`;
                          if (!matchingIdentities[identityKey]) {
                               matchingIdentities[identityKey] = {
                                    name: record.name,
                                    course: record.course,
                                    school: record.school,
                                    district: record.district
                               };
                          }
                     });

                     const sortedMatchingIdentities = Object.values(matchingIdentities).sort((a, b) => a.name.localeCompare(b.name));


                     if (sortedMatchingIdentities.length > 0) {
                         sortedMatchingIdentities.forEach(student => {
                              const displayString = `${student.name} (${student.course || '-'}, ${student.school || '-'}, ${student.district || '-'})`;
                              const identityJson = JSON.stringify({
                                   name: student.name,
                                   course: student.course,
                                   school: student.school,
                                   district: student.district
                              });
                             const li = document.createElement('li');
                             li.textContent = displayString;
                             li.dataset.studentIdentity = identityJson; // Almacenar JSON string en data attribute
                             autocompleteResultsUl.appendChild(li);
                         });
                         autocompleteResultsUl.classList.add('visible'); // Mostrar lista
                     } else {
                         autocompleteResultsUl.classList.remove('visible'); // Ocultar si no hay coincidencias
                     }
                 } else {
                     autocompleteResultsUl.classList.remove('visible'); // Ocultar si el input esta vacio
                 }

                 // Autocompletar otros campos si el nombre ingresado coincide exactamente con una identidad existente
                 // Buscar la identidad exacta en la lista de identidades unicas
                 const exactMatchIdentity = filteredStudentList.find(student => student.name.toLowerCase() === enteredName && student.course === studentCourseInput.value.trim() && student.school === studentSchoolSelect.value && student.district === studentDistrictSelect.value);

                 if (exactMatchIdentity) {
                      // Buscar el registro mas reciente para esta identidad
                      const studentRecords = allRecords.filter(record =>
                           record.name === exactMatchIdentity.name &&
                           record.course === exactMatchIdentity.course &&
                           record.school === exactMatchIdentity.school &&
                           record.district === exactMatchIdentity.district
                      );
                      if (studentRecords.length > 0) {
                           studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                           const mostRecentRecord = studentRecords[0];
                           studentAgeInput.value = mostRecentRecord.age || '';
                           studentSexSelect.value = mostRecentRecord.sex || '';
                           studentHeightInput.value = mostRecentRecord.height || '';
                           studentCourseInput.value = mostRecentRecord.course || '';
                           studentSchoolSelect.value = mostRecentRecord.school || '';
                           studentDistrictSelect.value = mostRecentRecord.district || '';
                      }
                 } else {
                      // Limpiar los campos si no hay una coincidencia exacta o registros existentes
                      // NOTA: Esto solo limpia si el NOMBRE EXACTO no coincide con una identidad existente.
                      // Si el usuario escribe "Juan" y hay varios "Juan", no limpia los otros campos.
                      // Podriamos limpiar si el nombre no coincide exactamente con *ninguna* identidad,
                      // o si el nombre + curso + escuela + distrito no coincide.
                      // Por ahora, limpiamos solo si el nombre exacto no se encuentra como parte de una identidad.
                      const nameExistsInRecords = allRecords.some(record => record.name && record.name.toLowerCase() === enteredName);
                       if (!nameExistsInRecords) {
                           studentAgeInput.value = '';
                           studentSexSelect.value = '';
                           studentHeightInput.value = '';
                           studentCourseInput.value = '';
                           studentSchoolSelect.value = '';
                           studentDistrictSelect.value = '';
                       }
                 }
             });

              // Event Listener para seleccionar un nombre de la lista de autocompletado
              autocompleteResultsUl.addEventListener('click', (event) => {
                  if (event.target.tagName === 'LI' && event.target.dataset.studentIdentity) {
                      const studentIdentityJson = event.target.dataset.studentIdentity;
                      const studentIdentity = JSON.parse(studentIdentityJson);

                      // Llenar el input de nombre con el nombre del alumno
                      studentNameInput.value = studentIdentity.name;

                      autocompleteResultsUl.innerHTML = ''; // Limpiar lista
                      autocompleteResultsUl.classList.remove('visible'); // Ocultar lista

                      // Buscar el registro mas reciente para llenar los otros campos
                      const studentRecords = allRecords.filter(record =>
                           record.name === studentIdentity.name &&
                           record.course === studentIdentity.course &&
                           record.school === studentIdentity.school &&
                           record.district === studentIdentity.district
                      );
                      if (studentRecords.length > 0) {
                           studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                           const mostRecentRecord = studentRecords[0];
                           studentAgeInput.value = mostRecentRecord.age || '';
                           studentSexSelect.value = mostRecentRecord.sex || '';
                           studentHeightInput.value = mostRecentRecord.height || '';
                           studentCourseInput.value = mostRecentRecord.course || '';
                           studentSchoolSelect.value = mostRecentRecord.school || '';
                           studentDistrictSelect.value = mostRecentRecord.district || '';
                      }
                  }
              });

               // Ocultar la lista de autocompletado si se hace clic fuera de ella
               document.addEventListener('click', (event) => {
                   if (!studentNameInput.contains(event.target) && !autocompleteResultsUl.contains(event.target)) {
                       autocompleteResultsUl.classList.remove('visible');
                   }
               });


             // Inicializar la lista de alumnos filtrados al cargar la pagina
             filterAndDisplayStudents();
             updateBackButtonState(); // Actualizar estado del boton Atras al cargar


              // Manejar la navegacion del historial del navegador (botones atras/adelante)
              window.addEventListener('popstate', (event) => {
                  // Si el historial de navegacion en sessionStorage es diferente al historial del navegador,
                  // sincronizarlo y navegar a la ultima seccion conocida.
                  const savedHistory = JSON.parse(sessionStorage.getItem('navigationHistory')) || [];
                  if (savedHistory.length > 0 && savedHistory[savedHistory.length - 1] !== currentSectionId) {
                       navigationHistory = savedHistory; // Sincronizar
                       const targetSectionId = navigationHistory[navigationHistory.length - 1];
                       // Usar navigateToSection para asegurar la logica de mostrar/ocultar y refrescar
                       navigateToSection(targetSectionId);
                  } else if (navigationHistory.length === 0 && currentSectionId !== 'add-record-section') {
                      // Si el historial esta vacio pero no estamos en la seccion inicial, ir a la inicial
                       navigateToSection('add-record-section');
                  } else {
                      // Si el historial coincide o estamos en la seccion inicial, simplemente asegurar
                      // que la UI refleje la seccion actual.
                      navigateToSection(currentSectionId);
                  }
              });

              // --- Logica para los nuevos Multi-Select con Checkboxes ---

              // Funcion para actualizar el texto del input multi-select
              function updateMultiSelectInputText(inputElement, dropdownElement, defaultText) {
                  const checkedCheckboxes = dropdownElement.querySelectorAll('input[type="checkbox"]:checked:not([value=""])');
                  const allCheckbox = dropdownElement.querySelector('input[type="checkbox"][value=""]');

                  if (allCheckbox && allCheckbox.checked) {
                      inputElement.value = defaultText;
                  } else if (checkedCheckboxes.length > 0) {
                      if (checkedCheckboxes.length === 1) {
                          inputElement.value = checkedCheckboxes[0].value;
                      } else {
                           inputElement.value = `${checkedCheckboxes.length} seleccionados`;
                      }
                  } else {
                      inputElement.value = `Seleccionar ${defaultText.toLowerCase().replace('todas las ', '').replace('todos los ', '')}`;
                  }
              }

              // Funcion para manejar la seleccion de checkboxes en un multi-select
              function handleMultiSelectCheckboxChange(dropdownElement, inputElement, defaultText) {
                  const checkboxes = dropdownElement.querySelectorAll('input[type="checkbox"]');
                  const allCheckbox = dropdownElement.querySelector('input[type="checkbox"][value=""]');

                  checkboxes.forEach(checkbox => {
                      checkbox.addEventListener('change', (event) => {
                          if (event.target.value === "") { // Si se selecciono/deselecciono "Todas"
                              checkboxes.forEach(cb => {
                                  if (cb !== allCheckbox) {
                                      cb.checked = allCheckbox.checked; // Marcar/desmarcar todas las demas
                                  }
                              });
                          } else { // Si se selecciono/deselecciono una opcion individual
                               // Si se deselecciona una opcion individual, desmarcar "Todas"
                              if (!event.target.checked && allCheckbox) {
                                  allCheckbox.checked = false;
                              }
                               // Si todas las opciones individuales estan marcadas, marcar "Todas"
                              const allOthersChecked = Array.from(checkboxes).filter(cb => cb !== allCheckbox).every(cb => cb.checked);
                              if (allOthersChecked && allCheckbox) {
                                  allCheckbox.checked = true;
                              }
                          }
                          // Actualizar el texto del input
                          updateMultiSelectInputText(inputElement, dropdownElement, defaultText);
                      });
                  });

                  // Actualizar el texto inicial del input
                  updateMultiSelectInputText(inputElement, dropdownElement, defaultText);
              }

              // Event Listeners para mostrar/ocultar los dropdowns multi-select
              filterSchoolInput.addEventListener('click', (event) => {
                  // Ocultar el otro dropdown si esta visible
                  filterDistrictDropdown.classList.remove('visible');
                  filterSchoolDropdown.classList.toggle('visible');
                  event.stopPropagation(); // Evitar que el clic se propague y cierre inmediatamente
              });

              filterDistrictInput.addEventListener('click', (event) => {
                  // Ocultar el otro dropdown si esta visible
                  filterSchoolDropdown.classList.remove('visible');
                  filterDistrictDropdown.classList.toggle('visible');
                   event.stopPropagation(); // Evitar que el clic se propague y cierre inmediatamente
              });

              // Ocultar los dropdowns multi-select si se hace clic fuera de ellos
              document.addEventListener('click', (event) => {
                  if (!filterSchoolDropdown.contains(event.target) && event.target !== filterSchoolInput) {
                      filterSchoolDropdown.classList.remove('visible');
                  }
                   if (!filterDistrictDropdown.contains(event.target) && event.target !== filterDistrictInput) {
                       filterDistrictDropdown.classList.remove('visible');
                   }
              });


              // Inicializar la logica de los multi-select con checkboxes
              handleMultiSelectCheckboxChange(filterSchoolDropdown, filterSchoolInput, 'Todas las Escuelas');
              handleMultiSelectCheckboxChange(filterDistrictDropdown, filterDistrictInput, 'Todos los Distritos');


             // --- Logica para el Analisis de Fortalezas y Debilidades y Ranking ---

             // Funcion para generar el analisis de fortalezas y debilidades y ranking
             function generateStudentAnalysis(studentIdentity) {
                  // Limpiar el contenido anterior del analisis (filas por prueba)
                  analysisRowsContainer.innerHTML = ''; // Limpiar filas de analisis
                  generalOlympicDistinctionsUl.innerHTML = ''; // Limpiar distinciones generales
                  // Limpiar iconos de distincion Top 1 en el nombre
                  const existingTop1Icons = selectedStudentNameDisplay.querySelector('.top1-distinction-icons');
                  if (existingTop1Icons) existingTop1Icons.remove();


                  const studentRecords = allRecords.filter(record =>
                      record.name === studentIdentity.name &&
                      record.course === studentIdentity.course &&
                      record.school === studentIdentity.school &&
                      record.district === studentIdentity.district &&
                      record.result !== undefined && record.result !== null && !isNaN(record.result) // Solo registros con resultados validos
                  );

                  const studentAge = studentRecords.length > 0 ? studentRecords[0].age : null;

                  if (studentRecords.length === 0) {
                       const noDataRow = document.createElement('div');
                       noDataRow.classList.add('analysis-item-row');
                       noDataRow.style.display = 'block'; // Ensure it displays as a block if it's the only content
                       noDataRow.innerHTML = `
                           <div class="neutral w-full p-3 text-center">No hay resultados validos para este alumno para generar analisis.</div>
                       `;
                       analysisRowsContainer.appendChild(noDataRow);
                       generalOlympicDistinctionsUl.classList.add('hidden'); // Ocultar lista de distinciones si no hay datos
                       return;
                  }

                  // Agrupar todos los resultados del alumno por tipo de prueba (para analisis de evolucion)
                   const studentRecordsGroupedByTest = studentRecords.reduce((acc, record) => {
                       if (!acc[record.testType]) {
                           acc[record.testType] = [];
                       }
                       acc[record.testType].push(record);
                       return acc;
                   }, {});


                  // Agrupar los mejores resultados del alumno por tipo de prueba (para analisis comparativo y ranking)
                  const studentBestResults = studentRecords.reduce((acc, record) => {
                       if (!acc[record.testType] || (record.testType === 'speed30m' || record.testType === 'run500m' ? record.result < acc[record.testType].result : record.result > acc[record.testType].result)) {
                           acc[record.testType] = record; // Store the full record object (best result)
                       }
                       return acc;
                  }, {});

                  const testTypesWithResults = Object.keys(studentBestResults).sort(); // Obtener tipos de prueba con resultados y ordenar


                  let top5Count = 0; // Contador para pruebas en Top 5
                  let top1Count = 0; // Contador para pruebas en Top 1


                  // --- Generar Analisis por Prueba (Horizontal) ---
                  testTypesWithResults.forEach(testType => {
                       const studentResultRecord = studentBestResults[testType];
                       const studentResult = studentResultRecord.result;
                       const testName = testTypeMap[testType] || testType;
                       const isLowerBetter = (testType === 'speed30m' || testType === 'run500m');

                       let averageAnalysisClass = 'neutral'; // Default class
                       let averageAnalysisText = ''; // Default text


                       // --- Analisis Comparativo (vs. Promedio de la misma edad) para esta prueba ---
                       if (studentAge !== null) {
                            const recordsSameAge = allRecords.filter(record =>
                                 record.age === studentAge &&
                                 record.testType === testType && // Filtrar por la prueba actual
                                 record.result !== undefined && record.result !== null && !isNaN(record.result)
                            );

                            if (recordsSameAge.length > 0) {
                                 // Obtener el mejor resultado para cada alumno de la misma edad para esta prueba
                                 const bestResultsForTestSameAge = recordsSameAge.reduce((acc, record) => {
                                      const identityKey = `${record.name}|${record.course}|${record.school}|${record.district}`;
                                      const isLowerBetterTest = (record.testType === 'speed30m' || record.testType === 'run500m');
                                      if (!acc[identityKey] || (isLowerBetterTest ? record.result < acc[identityKey].result : record.result > acc[identityKey].result)) {
                                           acc[identityKey] = record;
                                      }
                                      return acc;
                                 }, {});

                                 const resultsArray = Object.values(bestResultsForTestSameAge).map(record => record.result);
                                 const sum = resultsArray.reduce((total, result) => total + result, 0);
                                 const averageResult = sum / resultsArray.length;


                                 if (averageResult !== undefined && averageResult !== null && !isNaN(averageResult)) {
                                      const difference = studentResult - averageResult;
                                      const percentageDifference = averageResult === 0 ? (studentResult === 0 ? 0 : (studentResult > 0 ? 100 : -100)) : (difference / Math.abs(averageResult)) * 100;

                                      if (isLowerBetter) {
                                           if (percentageDifference < -STRENGTH_THRESHOLD_PERCENTAGE) {
                                                averageAnalysisClass = 'strength';
                                                averageAnalysisText = `<strong>${testName}:</strong> Excelente (${studentResult.toFixed(2)} vs Promedio ${averageResult.toFixed(2)}). Notable fortaleza.`;
                                           } else if (percentageDifference > WEAKNESS_THRESHOLD_PERCENTAGE) {
                                                averageAnalysisClass = 'weakness';
                                                averageAnalysisText = `<strong>${testName}:</strong> Area a mejorar (${studentResult.toFixed(2)} vs Promedio ${averageResult.toFixed(2)}). Significativamente por debajo del promedio.`;
                                           }
                                           // Si es "similar al promedio", averageAnalysisText permanece vacio.
                                      } else { // Mayor resultado es mejor (ej: repeticiones, distancia, flexibilidad)
                                           if (percentageDifference > STRENGTH_THRESHOLD_PERCENTAGE) {
                                                averageAnalysisClass = 'strength';
                                                averageAnalysisText = `<strong>${testName}:</strong> Excelente (${studentResult.toFixed(2)} vs Promedio ${averageResult.toFixed(2)}). Notable fortaleza.`;
                                           } else if (percentageDifference < -WEAKNESS_THRESHOLD_PERCENTAGE) {
                                                averageAnalysisClass = 'weakness';
                                                averageAnalysisText = `<strong>${testName}:</strong> Area a mejorar (${studentResult.toFixed(2)} vs Promedio ${averageResult.toFixed(2)}). Significativamente por debajo del promedio.`;
                                           }
                                           // Si es "similar al promedio", averageAnalysisText permanece vacio.
                                      }
                                 } else {
                                      averageAnalysisText = `<strong>${testName}:</strong> No hay suficientes datos de otros alumnos de ${studentAge} años para comparar.`;
                                      averageAnalysisClass = 'neutral'; // Treat as neutral if no comparison data
                                 }

                            } else {
                                 averageAnalysisText = `<strong>${testName}:</strong> No hay suficientes registros de alumnos de ${studentAge} años para esta prueba para generar un analisis comparativo.`;
                                 averageAnalysisClass = 'neutral'; // Treat as neutral if no comparison data
                            }
                       } else {
                            averageAnalysisText = `<strong>${testName}:</strong> La edad del alumno no esta registrada, no se puede generar un analisis comparativo por edad.`;
                            averageAnalysisClass = 'neutral'; // Treat as neutral if no age data
                       }


                       // --- Analisis de Ranking (vs. Todos los Alumnos) para esta prueba ---
                       let rankingAnalysisText = '';
                       const allStudentsBestResultsForTest = getAllStudentsBestResultsForTest(testType);

                       // Filter out results that are not valid numbers
                       const validResults = allStudentsBestResultsForTest.filter(r => r.result !== undefined && r.result !== null && !isNaN(r.result));

                       // Check if there are enough participants for a meaningful ranking
                       if (validResults.length < MIN_PARTICIPANTS_FOR_RANKING) {
                            rankingAnalysisText = `<strong>${testName}:</strong> Se necesitan al menos ${MIN_PARTICIPANTS_FOR_RANKING} resultados validos para esta prueba para generar un ranking. (Actualmente: ${validResults.length})`;
                       } else {
                           // Sort results to determine rank
                           validResults.sort((a, b) => {
                               if (a.result === b.result) {
                                    // Tie-breaking: older date first
                                    return new Date(a.date) - new Date(b.date);
                               }
                               if (isLowerBetter) {
                                   return a.result - b.result; // Ascending for lower is better
                               } else {
                                   return b.result - a.result; // Descending for higher is better
                               }
                           });

                           // Find the student's rank by comparing the record ID
                           let studentRank = -1;
                           for(let i = 0; i < validResults.length; i++) {
                               if (validResults[i].id === studentResultRecord.id) { // Compare by unique record ID
                                    studentRank = i + 1; // Rank is 1-based index + 1
                                    break; // Found the student's result, stop searching
                               }
                           }

                           if (studentRank !== -1) { // Ensure rank was found
                                let iconHtml = '';
                               if (studentRank <= 5) {
                                    // Alerta de Talento (Top 5) - Anadir icono de estrella
                                    iconHtml = '<i class="fas fa-star text-yellow-500 mr-1" title="Alerta de Talento (Top 5)"></i>';
                                    top5Count++; // Incrementar contador de Top 5
                                    if (studentRank === 1) {
                                         top1Count++; // Incrementar contador de Top 1
                                    }
                               } else if (studentRank <= 10) {
                                    // Distincion Honorifica (6-10) - Anadir icono de medalla gris
                                    iconHtml = '<i class="fas fa-medal text-gray-500 mr-1" title="Distincion Honorifica (Puestos 6-10)"></i>';
                               }
                                rankingAnalysisText = `${iconHtml}<strong>${testName}:</strong> Puesto ${studentRank} de ${validResults.length}.`;

                           } else {
                               // Should not happen if studentBestResultsAllTests was derived from allRecords, but as a fallback
                               rankingAnalysisText = `<strong>${testName}:</strong> No se pudo determinar el ranking para esta prueba.`;
                           }
                       }


                       // --- Analisis de Evolucion (entre las dos ultimas fechas) ---
                       const studentRecordsForTest = studentRecordsGroupedByTest[testType] || [];
                       let evolutionMessageContainer = null; // Use a variable to hold the element

                       // Filter and sort records for this specific test by date (most recent first)
                       const sortedTestRecords = studentRecordsForTest
                           .filter(record => record.result !== undefined && record.result !== null && !isNaN(record.result))
                           .sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first

                       // Only generate evolution message if there are at least 2 records and a significant change
                       if (sortedTestRecords.length >= 2) {
                           const latestRecord = sortedTestRecords[0];
                           const secondLatestRecord = sortedTestRecords[1];

                           const latestResult = latestRecord.result;
                           const secondLatestResult = secondLatestRecord.result;

                           // Calculate percentage difference
                           // Avoid division by zero if the second latest result is 0
                           const percentageChange = secondLatestResult === 0
                               ? (latestResult === 0 ? 0 : (latestResult > 0 ? 100 : -100)) // Handle case where previous result was 0
                               : ((latestResult - secondLatestResult) / Math.abs(secondLatestResult)) * 100;

                           let evolutionClass = '';
                           let evolutionText = '';

                           if (isLowerBetter) { // For speed, 500m: Lower percentage change (more negative) is improvement
                                if (percentageChange < -EVOLUTION_THRESHOLD_PERCENTAGE) {
                                     evolutionClass = 'positive';
                                     evolutionText = `¡Gran mejora! Su ${testName.toLowerCase()} ha disminuido un ${Math.abs(percentageChange).toFixed(1)}% entre las ultimas dos pruebas.`;
                                } else if (percentageChange > EVOLUTION_THRESHOLD_PERCENTAGE) {
                                     evolutionClass = 'negative';
                                     evolutionText = `Alerta: Su ${testName.toLowerCase()} ha aumentado un ${percentageChange.toFixed(1)}% entre las ultimas dos pruebas.`;
                                }
                           } else { // For jump, situps, etc.: Higher percentage change (more positive) is improvement
                                if (percentageChange > EVOLUTION_THRESHOLD_PERCENTAGE) {
                                     evolutionClass = 'positive';
                                     evolutionText = `¡Gran mejora! Su ${testName.toLowerCase()} ha aumentado un ${percentageChange.toFixed(1)}% entre las ultimas dos pruebas.`;
                                } else if (percentageChange < -EVOLUTION_THRESHOLD_PERCENTAGE) {
                                     evolutionClass = 'negative';
                                     evolutionText = `Alerta: Su ${testName.toLowerCase()} ha disminuido un ${Math.abs(percentageChange).toFixed(1)}% entre las ultimas dos pruebas.`;
                                }
                           }

                           if (evolutionText) {
                                // Create the evolution message container element only if there's a message
                                evolutionMessageContainer = document.createElement('div');
                                evolutionMessageContainer.classList.add('evolution-message-container', evolutionClass);
                                evolutionMessageContainer.textContent = evolutionText;
                           }

                       }
                       // If sortedTestRecords.length < 2 or change is not significant, evolutionMessageContainer remains null.


                       // --- Construir y Anadir la Fila de Analisis para CADA prueba con resultado ---
                        const analysisItemRow = document.createElement('div');
                        analysisItemRow.classList.add('analysis-item-row');

                        const averageAnalysisDiv = document.createElement('div');
                        averageAnalysisDiv.classList.add('w-full', 'md:w-1/2', averageAnalysisClass);
                        averageAnalysisDiv.innerHTML = averageAnalysisText; // Use innerHTML to include <strong>

                        const rankingAnalysisDiv = document.createElement('div');
                        rankingAnalysisDiv.classList.add('w-full', 'md:w-1/2', 'ranking-item');
                         rankingAnalysisDiv.innerHTML = rankingAnalysisText; // Use innerHTML to include <strong> and icons

                        // Solo añadir los divs si tienen contenido
                        if (averageAnalysisText) {
                            analysisItemRow.appendChild(averageAnalysisDiv);
                        } else {
                            // If no average analysis text, still add a placeholder div to maintain layout
                            const emptyAverageDiv = document.createElement('div');
                            emptyAverageDiv.classList.add('w-full', 'md:w-1/2', averageAnalysisClass);
                            analysisItemRow.appendChild(emptyAverageDiv);
                        }
                        analysisItemRow.appendChild(rankingAnalysisDiv);

                         // Append the evolution message container element if it was created (significant evolution)
                         if (evolutionMessageContainer) {
                              analysisItemRow.appendChild(evolutionMessageContainer);
                         }

                        analysisRowsContainer.appendChild(analysisItemRow);

                  });


                   // --- Anadir Distinciones Olimpicas Generales (basadas en los contadores top5Count y top1Count) ---
                   // Limpiar distinciones generales anteriores
                   generalOlympicDistinctionsUl.innerHTML = '';


                   if (top1Count >= 3) { // Nueva distincion: Top 1 en 3+ pruebas
                        const top1DistinctionItem = document.createElement('li');
                        top1DistinctionItem.classList.add('olympic-distinction', 'triple-crown'); // Reutilizar clase triple-crown para estilo
                        top1DistinctionItem.innerHTML = `<i class="fas fa-crown gold mr-2"></i><i class="fas fa-gem gold mr-2"></i> ¡Campeón Supremo! Top 1 en ${top1Count} pruebas.`;
                        generalOlympicDistinctionsUl.appendChild(top1DistinctionItem);

                         // Anadir iconos al lado del nombre del alumno
                         const newTop1IconsSpan = document.createElement('span'); // Renamed to avoid redeclaration
                         newTop1IconsSpan.classList.add('top1-distinction-icons');
                         newTop1IconsSpan.innerHTML = `<i class="fas fa-crown text-yellow-500"></i> <i class="fas fa-gem text-blue-500"></i>`;
                         // Buscar el span que contiene el nombre y anadir los iconos despues
                         const nameSpan = document.getElementById('selected-student-name-display');
                         if (nameSpan) {
                              nameSpan.appendChild(newTop1IconsSpan);
                         }


                   } else if (top5Count >= 4) { // Nueva distincion: Top 5 en 4+ pruebas
                       const quadCrownItem = document.createElement('li');
                       quadCrownItem.classList.add('olympic-distinction', 'quad-crown'); // Nueva clase para estilo
                       quadCrownItem.innerHTML = `<i class="fas fa-trophy gold mr-2"></i> ¡Cuádruple Corona Olímpica! Top 5 en ${top5Count} pruebas.`;
                       generalOlympicDistincionsUl.appendChild(quadCrownItem);
                   } else if (top5Count === 3) {
                       const tripleCrownItem = document.createElement('li');
                       tripleCrownItem.classList.add('olympic-distinction', 'triple-crown'); // Clase para estilo
                       tripleCrownItem.innerHTML = `<i class="fas fa-trophy gold mr-2"></i>¡Triple Corona Olímpica! Top 5 en 3 pruebas.`;
                       generalOlympicDistinctionsUl.appendChild(tripleCrownItem);
                   } else if (top5Count === 2) {
                       const doubleGoldItem = document.createElement('li');
                       doubleGoldItem.classList.add('olympic-distinction', 'double-gold'); // Clase para estilo
                       doubleGoldItem.innerHTML = `<i class="fas fa-medal gold mr-2"></i>¡Doble Oro Olímpico! Top 5 en 2 pruebas.`;
                       generalOlympicDistinctionsUl.appendChild(doubleGoldItem);
                   }


                   // Si no se genero ninguna distincion general, ocultar la lista
                   if (generalOlympicDistinctionsUl.children.length === 0) {
                       generalOlympicDistinctionsUl.classList.add('hidden');
                   } else {
                       generalOlympicDistinctionsUl.classList.remove('hidden');
                   }


                   // If no analysis rows were generated (only happens if testTypesWithResults.length is 0), show a message
                   if (testTypesWithResults.length === 0) {
                       const noDataRow = document.createElement('div');
                       noDataRow.classList.add('analysis-item-row'); // Use the same row class for consistency
                       noDataRow.style.display = 'block'; // Ensure it displays as a block if it's the only content
                       noDataRow.innerHTML = `
                           <div class="neutral w-full p-3 text-center">No hay resultados validos para este alumno para generar analisis.</div>
                       `;
                       analysisRowsContainer.appendChild(noDataRow);
                   }


             }

             // Helper function to get the best result for each unique student for a given test type
             function getAllStudentsBestResultsForTest(testType) {
                 const recordsForTest = allRecords.filter(record =>
                     record.testType === testType &&
                     record.result !== undefined && record.result !== null && !isNaN(record.result)
                 );

                 const bestResultsByIdentity = recordsForTest.reduce((acc, record) => {
                     const identityKey = `${record.name}|${record.course}|${record.school}|${record.district}`;
                     const isLowerBetter = (testType === 'speed30m' || testType === 'run500m');

                     if (!acc[identityKey] || (isLowerBetter ? record.result < acc[identityKey].result : record.result > acc[identityKey].result)) {
                         acc[identityKey] = record; // Store the full record object
                     }
                     return acc;
                 }, {});

                 return Object.values(bestResultsByIdentity); // Return an array of the best record objects
             }


        }; // Fin de window.onload

    </script>
</body>
</html>
